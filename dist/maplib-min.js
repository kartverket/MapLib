var ISY;(ISY=ISY||{}).Domain=ISY.Domain||{},ISY.Domain.Category=function(e){for(var t=$.extend({},{catId:-1,name:"",isOpen:!1,parentId:-1,subCategories:[],isyLayers:[],isAllLayersSelected:!1},e),n=[],o=0;o<e.subCategories.length;o++)n.push(new ISY.Domain.Category(e.subCategories[o]));return t.subCategories=n,t},(ISY=ISY||{}).Domain=ISY.Domain||{},ISY.Domain.FeatureInfo=function(e){return $.extend({},{supportsGetFeatureInfo:!0,getFeatureInfoFormat:"application/json",getFeatureInfoCrs:"",supportsGetFeature:!0,getFeatureBaseUrl:"",getFeatureFormat:"application/json",getFeatureCrs:"EPSG:4326"},e)},(ISY=ISY||{}).Domain=ISY.Domain||{},ISY.Domain.FeatureResponse=function(){return{geometryObject:"",crs:"",attributes:[]}},(ISY=ISY||{}).Domain=ISY.Domain||{},ISY.Domain.Layer=function(e){for(var t={guid:"",subLayers:[],name:"",categoryId:0,visibleOnLoad:!0,isVisible:!1,id:(new ISY.Utils.Guid).NewGuid(),isBaseLayer:!1,previewActive:!1,opacity:1,mapLayerIndex:-1,minResolution:0,maxResolution:1/0,legendGraphicUrls:[],selectedLayerOpen:!1},n=$.extend({},t,e),o=[],r=0;r<e.subLayers.length;r++)o.push(new ISY.Domain.SubLayer(e.subLayers[r]));return n.subLayers=o,n},(ISY=ISY||{}).Domain=ISY.Domain||{},ISY.Domain.LayerResponse=function(){return{id:-1,isLoading:!1,exception:"",features:[]}},(ISY=ISY||{}).Domain=ISY.Domain||{},ISY.Domain.LegendGraphic=function(e){var t=$.extend({},{width:"20",height:"20",format:"image/png",request:"GetLegendGraphic",version:"1.0.0",service:"wms",layer:"",url:""},e);return{GetLegendGraphicUrl:function(){return"?"!==t.url?t.url+"Service="+t.service+"&Request="+t.request+"&Version="+t.version+"&Format="+t.format+"&Width="+t.width+"&Height="+t.height+"&Layer="+t.layer:""}}},(ISY=ISY||{}).Domain=ISY.Domain||{},ISY.Domain.MeasureResult=function(e,t,n){var o=e,r=t,a=n;function i(){return o}function s(){return r}function l(){return a}return{PolygonArea:i,EdgeLength:s,CircleArea:l,GetParsedResult:function(){return"Polygon area: "+i()+" Length: "+s()+" Circle area: "+l()}}},(ISY=ISY||{}).Domain=ISY.Domain||{},ISY.Domain.SubLayer=function(e){var t=(new ISY.Utils.Guid).NewGuid(),n={name:"",providerName:"",source:ISY.Domain.SubLayer.SOURCES.wmts,url:"",format:ISY.Domain.SubLayer.FORMATS.imagepng,coordinate_system:"",srs_dimension:"",matrixSet:"",extent:[-1,1,-1,1],extentUnits:"m",id:t,transparent:!0,layerIndex:-1,legendGraphicUrl:"",crossOrigin:"anonymous",featureInfoTitle:"",tooltipTemplate:"",showDialog:!0,openNewWindow:!1,openParentWindow:!1,windowWidth:500,featureInfoElement:[],editable:!1,featureInfo:new ISY.Domain.FeatureInfo,featureNS:"",geometryName:"geometry"},o=$.extend({},n,e);if(-1===o.legendGraphicUrl.indexOf("?")&&(o.legendGraphicUrl+="?"),""!==o.legendGraphicUrl){var r=new ISY.Domain.LegendGraphic({url:o.legendGraphicUrl,layer:o.name});o.legendGraphicUrl=r.GetLegendGraphicUrl()}return o},ISY.Domain.SubLayer.SOURCES={wmts:"WMTS",wms:"WMS",vector:"VECTOR",proxyWmts:"proxyWmts",proxyWms:"proxyWms",tms:"TMS",wfs:"WFS"},ISY.Domain.SubLayer.FORMATS={imagepng:"image/png",imagejpeg:"image/jpeg",geoJson:"application/json"},(ISY=ISY||{}).Events=ISY.Events||{},ISY.Events.EventHandler=function(){var r=[];return{RegisterEvent:function(e,t){r.push({eventType:e,callBack:t})},UnRegisterEvent:function(e,t){for(var n=r.length-1;0<=n;n--)if(r[n].eventType==e&&(r[n].callBack==t||!1===t)){r.splice(n,1);break}},UnRegisterAllEvents:function(){r=[]},TriggerEvent:function(e,t){for(var n=0;n<r.length;n++){var o=r[n];o.eventType===e&&o.callBack(t)}}}},ISY.Events.EventTypes={ChangeCenter:"ChangeCenter",ChangeResolution:"ChangeResolution",ChangeLayers:"ChangeLayers",FeatureInfoStart:"FeatureInfoStart",FeatureInfoEnd:"FeatureInfoEnd",MapConfigLoaded:"MapConfigLoaded",MapLoaded:"MapLoaded",MapMoveend:"MapMoveend",ShowExportPanel:"ShowExportPanel",MeasureMouseMove:"MeasureMouseMove",LoadingLayerEnd:"LoadingLayerEnd",LayerCreated:"LayerCreated",CachingStart:"CachingStart",CachingEnd:"CachingEnd",CachingProgress:"CachingProgress",StatusPouchDbChanged:"StatusPouchDbChanged",MeasureEnd:"MeasureEnd",DrawFeatureMouseMove:"DrawFeatureMouseMove",DrawFeatureEnd:"DrawFeatureEnd",DrawFeatureSelect:"DrawFeatureSelect",AddLayerFeatureEnd:"AddLayerFeatureEnd",ModifyFeatureEnd:"ModifyFeatureEnd",RefreshSourceDone:"RefreshSourceDone",ZoomIn:"ZoomIn",ZoomOut:"ZoomOut",TransactionSuccessful:"TransactionSuccessful",TransactionFailed:"TransactionFailed",TransactionInsertEnd:"TransactionInsertEnd",TransactionUpdateEnd:"TransactionUpdateEnd",TransactionRemoveEnd:"TransactionRemoveEnd",FeatureHasBeenDescribed:"FeatureHasBeenDescribed",GeolocationUpdated:"GeolocationUpdated",PrintBoxSelectReturnValue:"PrintBoxSelectReturnValue",MapClickCoordinate:"MapClickCoordinate",AddLayerUrlEnd:"AddLayerUrlEnd"},(ISY=ISY||{}).Facade=ISY.Facade||{},ISY.Facade.ServerConfigFacade=function(){return{GetMapConfig:function(e,t){$.getJSON(e,function(e){t(e)})}}},(ISY=ISY||{}).MapAPI=ISY.MapAPI||{},ISY.MapAPI.Categories=function(){var a=[];function t(e){a=e.categories}return{Init:t,ReInit:function(e){a=[],t(e)},GetCategoryById:function(e){for(var t=0;t<a.length;t++){var n=a[t];if(n.catId.toString()===e.toString())return n;for(var o=0;o<a[t].subCategories.length;o++){var r=a[t].subCategories[o];if(r.catId.toString()===e.toString())return r}}},GetCategories:function(){return a}}},(ISY=ISY||{}).MapAPI=ISY.MapAPI||{},ISY.MapAPI.CustomCrsLoader=function(){return{LoadCustomCrs:function(){proj4.defs("EPSG:25831","+proj=utm +zone=31 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs"),proj4.defs("EPSG:25832","+proj=utm +zone=32 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs"),proj4.defs("EPSG:25833","+proj=utm +zone=33 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs"),proj4.defs("EPSG:25834","+proj=utm +zone=34 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs"),proj4.defs("EPSG:25835","+proj=utm +zone=35 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs"),proj4.defs("EPSG:25836","+proj=utm +zone=36 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs"),proj4.defs("EPSG:32631","+proj=utm +zone=31 +datum=WGS84 +units=m +no_defs"),proj4.defs("EPSG:32632","+proj=utm +zone=32 +datum=WGS84 +units=m +no_defs"),proj4.defs("EPSG:32633","+proj=utm +zone=33 +datum=WGS84 +units=m +no_defs"),proj4.defs("EPSG:32634","+proj=utm +zone=34 +datum=WGS84 +units=m +no_defs"),proj4.defs("EPSG:32635","+proj=utm +zone=35 +datum=WGS84 +units=m +no_defs"),proj4.defs("EPSG:32636","+proj=utm +zone=36 +datum=WGS84 +units=m +no_defs"),proj4.defs("EPSG:3575","+proj=laea +lat_0=90 +lon_0=10 +x_0=0 +y_0=0 +datum=WGS84 +units=m +no_defs"),proj4.defs("EPSG:4258","+proj=longlat +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +no_defs")}}},(ISY=ISY||{}).MapAPI=ISY.MapAPI||{},ISY.MapAPI.Map=ISY.MapAPI.Map||{},ISY.MapAPI.FeatureInfo=function(c,i,g,v){var n,t="assets/img/pin-md-orange.png",s=!1;function f(e){var t=function(e){for(var t=[],n=0;n<e.length;n++){var o=e[n],r=new ISY.Domain.LayerResponse;r.id=o.id,r.name=o.providerName,r.isLoading=!0,t.push(r)}return t}(e);g.TriggerEvent(ISY.Events.EventTypes.FeatureInfoStart,t)}function d(e,t){i.get(e).then(function(e){p(t,e)})}function S(e,t){if(!t.featureInfo||!t.featureInfo.includedFields)return e;var n,o,r=(n=t.featureInfo.includedFields,o={},n.field&&(n.field.constructor!==Array&&(n.field=[n.field]),n.field.forEach(function(e){"picture"===e.type||"link"===e.type||"symbol"===e.type||"boolean"===e.type?(o[e.name]={name:e.alias?e.alias:e.name,type:e.type},e.baseurl&&(o[e.name].baseurl=e.baseurl,o[e.name].filetype=e.filetype?"."+e.filetype:"")):o[e.name]={name:e.alias?e.alias:e.name,unit:e.unit?e.unit:""}})),"true"===n.capitalize&&(o._capitalize=!0),o),a=[];return e.forEach(function(e){a.push(function(e,t,n){var o={attributes:[]};if(1<Object.keys(e).length){for(var r in e)if("object"==typeof e[r]){var a,i=t[r];if(-1<Object.keys(t).indexOf(r)?(a=e._capitalize?e[r].name.toLowerCase().capitalizeFirstLetter():e[r].name,"symbol"===e[r].type&&e[r].baseurl||"picture"===e[r].type&&e[r].baseurl||"link"===e[r].type&&e[r].baseurl?i={url:e[r].baseurl+t[r]+e[r].filetype,type:e[r].type,name:t[r]}:e[r].unit?i+=e[r].unit:"boolean"===e[r].type&&(i="t"===i?"Ja":"Nei")):a=1===Object.keys(t).length?t._capitalize?r.toLowerCase().capitalizeFirstLetter():r:e._capitalize?e[r].name.toLowerCase().capitalizeFirstLetter():e[r].name,void 0!==n)for(var s in n)a===s&&(i=n[s][i]);o.attributes.push([a,i])}}else for(var l in t){var u=t._capitalize?l.toLowerCase().capitalizeFirstLetter():l;o.attributes.push([u,t[l]])}return o}(r,e,t.featureInfo.featureDict))}),a}function p(e,t){var n,o,r;if(e.featureInfo.supportsGetFeatureInfo&&"WMS"===e.source){var a=jQuery.parseXML(t.data),i=xml.xmlToJSON(a);if(i.hasOwnProperty("msGMLOutput"))if(i.msGMLOutput.hasOwnProperty(e.providerName+"_layer")){n=[],(r=i.msGMLOutput[e.providerName+"_layer"][e.providerName+"_feature"]).constructor!==Array&&(r=[r]);for(var s=0;s<r.length;s++)n.push(r[s])}else for(var l in i.msGMLOutput)if(l.endsWith("layer")){var u=l.substr(0,l.indexOf("layer"));n=[],(r=i.msGMLOutput[l][u+"feature"]).constructor!==Array&&(r=[r]);for(var c=0;c<r.length;c++)n.push(r[c])}}else try{if(e.featureInfo.includedFields){n=[];for(var f=t.features,d=0;d<f.length;d++){var p=f[d].properties;f[d].id&&(p.id=f[d].id),n.push(p)}}else n=v.Parse(t)}catch(e){o=e}if(n){n=S(n,e);var m=new ISY.Domain.LayerResponse;m.id=e.id,m.name=e.providerName,m.isLoading=!1,m.features=n,m.exception=o,m.featureInfoTitle=e.featureInfoTitle,e.source!==ISY.Domain.SubLayer.SOURCES.proxyWms&&e.source!==ISY.Domain.SubLayer.SOURCES.proxyWmts&&e.source!==ISY.Domain.SubLayer.SOURCES.wms&&e.source!==ISY.Domain.SubLayer.SOURCES.wmts||(m.wms=!0),m.featureInfoElement=e.featureInfoElement,m.showDialog=e.showDialog,m.openNewWindow=e.openNewWindow,m.openParentWindow=e.openParentWindow,m.windowWidth=e.windowWidth,m.editable=e.editable,g.TriggerEvent(ISY.Events.EventTypes.FeatureInfoEnd,m)}}function o(e,t,o){var n,r=e.url.replace("proxy/wms","proxy/");-1<r.indexOf("?")||(r+=encodeURIComponent("?"));var a="SERVICE="+t+"&REQUEST=GETCAPABILITIES";e.source!==ISY.Domain.SubLayer.SOURCES.proxyWms&&e.source!==ISY.Domain.SubLayer.SOURCES.proxyWmts||(a=encodeURIComponent(a)),n=r+a,i.get(n).success(function(e){var t,n=(t=e,(new ol.format.WMSCapabilities).read(t));o(n)})}function r(){(n=document.createElement("img")).src=t,u(),document.body.appendChild(n)}function l(e){void 0===n&&r(),a(n,!0),n.style.visibility="visible",n.style.position="absolute",n.style.zIndex="11",c.ShowInfoMarker(e,n)}function a(e,t){!0===s&&(!0===t&&(void 0===n&&r(),c.RemoveInfoMarker(n),u(),s=!1),n=e)}function u(){n.style.visibility="hidden"}return String.prototype.capitalizeFirstLetter=function(){return this.charAt(0).toUpperCase()+this.slice(1)},{HandlePointSelect:function(e,t){!0===s&&l(e),g.TriggerEvent(ISY.Events.EventTypes.MapClickCoordinate,e),f(t);for(var n=0;n<t.length;n++){var o=t[n];switch(o.source){case ISY.Domain.SubLayer.SOURCES.wmts:case ISY.Domain.SubLayer.SOURCES.wms:case ISY.Domain.SubLayer.SOURCES.proxyWms:case ISY.Domain.SubLayer.SOURCES.proxyWmts:r=o,a=e,i=void 0,i=c.GetInfoUrl(r,a),d(i=decodeURIComponent(i),r);break;case ISY.Domain.SubLayer.SOURCES.wfs:case ISY.Domain.SubLayer.SOURCES.vector:p(o,c.GetFeaturesInExtent(o,c.GetExtentForCoordinate(e,10)))}}var r,a,i},HandleBoxSelect:function(e,t){f(t);for(var n=0;n<t.length;n++){var o=t[n];switch(o.source){case ISY.Domain.SubLayer.SOURCES.wmts:case ISY.Domain.SubLayer.SOURCES.wms:case ISY.Domain.SubLayer.SOURCES.proxyWms:case ISY.Domain.SubLayer.SOURCES.proxyWmts:l=o,u=e,d(c.GetProxyHost()+(a=u,s=i=void 0,i=(r=l).featureInfo.getFeatureCrs,s="service=WMS&version=1.3.0&request=GetFeatureInfo&TRANSPARENT="+r.transparent+"&QUERY_LAYERS="+r.name+"&INFO_FORMAT="+r.featureInfo.getFeatureInfoFormat+"&SRS="+i+"&bbox="+a+"&width=400&height=400&x=150&y=150",s=(s=(s=decodeURIComponent(s)).substring(s.lastIndexOf("?"),s.length)).replace("?",""),s=encodeURIComponent(s),r.url[0].replace("proxy/wms","proxy/")+s),l);break;case ISY.Domain.SubLayer.SOURCES.wfs:case ISY.Domain.SubLayer.SOURCES.vector:p(o,c.GetFeaturesInExtent(o,e))}}var r,a,i,s,l,u},CreateDefaultInfoMarker:r,SetInfoMarker:a,RemoveInfoMarker:function(){a(n,s=!0)},RemoveInfoMarkers:function(){c.RemoveInfoMarkers(void 0)},GetSupportedGetFeatureInfoFormats:function(e,n){o(e,"WMS",function(e){var t=e.Capability.Request.GetFeatureInfo.Format;n(t)})},GetSupportedGetFeatureFormats:function(e,n){o(e,"WFS",function(e){var t=e.Capability.Request.GetFeature.Format;n(t)})},SetInfoMarkerPath:function(e){t=e},ShowInfoMarker:function(e){l(e)},ShowInfoMarkers:function(e){var t;t=e,c.ShowInfoMarkers(t,n)}}},(ISY=ISY||{}).MapAPI=ISY.MapAPI||{},ISY.MapAPI.Groups=function(){var a=[];function t(e){a=e.groups}return{Init:t,ReInit:function(e){a=[],t(e)},GetGroupById:function(e){for(var t=0;t<a.length;t++){var n=a[t];if(n.groupId.toString()===e.toString())return n;for(var o=0;o<a[t].subCategories.length;o++){var r=a[t].subCategories[o];if(r.groupId.toString()===e.toString())return r}}},GetGroups:function(){return a}}},(ISY=ISY||{}).MapAPI=ISY.MapAPI||{},ISY.MapAPI.Layers=function(i){var l,u,r;function t(e){u=(l=e).layers,function(){for(var e=0,t=c(),n=0;n<t.length;n++)for(var o=t[n],r=0;r<o.subLayers.length;r++)o.subLayers[r].layerIndex=e,e++;for(var a=f(),i=0;i<a.length;i++)for(var s=a[i],l=0;l<s.subLayers.length;l++)s.subLayers[l].layerIndex=e,e++}();for(var t=c(),n=!1,o=0;o<t.length;o++){var r=t[o];r.visibleOnLoad?(d(r),n=!0):!1===n&&(r.visibleOnLoad=!0,d(r),n=!0)}for(var a=f(),i=0;i<a.length;i++){var s=a[i];s.visibleOnLoad?p(s):m(s)}}function e(){return void 0!==l?l.layers:[]}function a(e,t){return e.id<t.id?-1:e.id>t.id?1:0}function c(){return e().filter(function(e){return!0===e.isBaseLayer})}function f(){return e().filter(function(e){return!1===e.isBaseLayer})}function d(e){for(var t=o(),n=0;n<t.length;n++){m(t[n])}!function(e){for(var t=e.subLayers,n=0;n<t.length;n++){var o=t[n];i.ShowBaseLayer(o)}e.isVisible=!0,function(){for(var e=s(),t=0;t<e.length;t++){var n=e[t];n.mapLayerIndex=g(n)}}()}(e)}function p(e){for(var t=e.subLayers,n=0;n<t.length;n++){var o=t[n];i.ShowLayer(o)}e.isVisible=!0}function m(e){var t=e.subLayers;e.isVisible=!1;for(var n=0;n<t.length;n++){var o=t[n];i.HideLayer(o)}e.mapLayerIndex=-1}function o(){return c().filter(function(e){return!0===e.isVisible})}function s(){return f().filter(function(e){return!0===e.isVisible})}function n(){return!0}function g(e){for(var t=e.subLayers,n=[],o=0;o<t.length;o++){var r=t[o],a=i.GetLayerIndex(r);null!==a&&n.push(a)}return Math.max(n)}return{Init:t,ReInit:function(e){r=u=l=void 0,t(e)},ArrangeLayers:function(){if(!r){r=!0;for(var e=f(),t=[],n=0;n<e.length;n++){var o=e[n];o.isVisible&&t.push(o)}t.sort(a),t.forEach(function(e){p(e)})}},GetBaseLayers:c,GetOverlayLayers:f,SetBaseLayer:d,AddLayer:function(e){p(e),u.push(e)},HideLayer:m,ShowLayer:p,GetVisibleSubLayers:function(){for(var e=[],t=s(),n=0;n<t.length;n++)for(var o=t[n],r=0;r<o.subLayers.length;r++){var a=o.subLayers[r];e.push(a)}return e},GetVisibleBaseLayers:o,GetLayerById:function(e){if(void 0!==u)for(var t=0;t<u.length;t++){var n=u[t];if(n.id.toString()===e.toString())return n}},MoveLayerToIndex:function(e,t){for(var n=e.subLayers,o=0;o<n.length;o++){var r=n[o];i.MoveLayerToIndex(r,t)}i.RedrawMap()},MoveLayerToIndexInGroup:function(){!function(){for(var e=1,t=0;t<l.groups.length&&void 0!==l.groups[t].isyLayers;t++)for(var n=0;n<l.groups[t].isyLayers.length;n++)for(var o=0;o<l.groups[t].isyLayers[n].subLayers.length;o++)l.groups[t].isyLayers[n].subLayers[o].sortingIndex=e,e+=1}(),i.UpdateLayerSortIndex(l.groups),i.SortLayerBySortIndex(),i.RedrawMap()},MoveLayerAbove:function(e,t){for(var n=g(t),o=e.subLayers,r=0;r<o.length;r++){var a=o[r];i.MoveLayerToIndex(a,n)}},ShouldBeVisible:n}},(ISY=ISY||{}).MapAPI=ISY.MapAPI||{},ISY.MapAPI.Map=function(a,n,o,r,i,s){var l;function u(e){if("undefined"!=typeof ol){var t=new ol.proj.Projection({code:e,units:"m"});ol.proj.addProjection(t)}}function c(e){r.ShowLayer(e)}function f(e){r.SetBaseLayer(e)}function t(){return r.GetVisibleSubLayers()}function d(e){return r.GetLayerById(e)}function p(e){o.HandlePointSelect(e,t().filter(function(e){return!!e.featureInfo&&!0===e.featureInfo.supportsGetFeatureInfo}))}function e(e){o.HandleBoxSelect(e,t().filter(function(e){return!0===e.featureInfo.supportsGetFeature}))}function m(e){a.HandlePointSelect(e)}return{Init:function(e,t){(new ISY.MapAPI.CustomCrsLoader).LoadCustomCrs(),u("EPSG:25832"),u("EPSG:25833"),u("EPSG:25834"),u("EPSG:25835"),u("EPSG:25836"),u("EPSG:32632"),u("EPSG:32633"),u("EPSG:32634"),u("EPSG:32635"),u("EPSG:32636"),u("EPSG:4258"),l=t,a.InitMap(e,t),r.Init(t),i.Init(t),s.Init(t),n.TriggerEvent(ISY.Events.EventTypes.MapLoaded)},ReInit:function(e){a.ReInitMap(e),r.ReInit(e),i.ReInit(e),s.ReInit(e)},AddLayer:function(e){r.AddLayer(e)},AddDataToLayer:function(e,t){a.AddDataToLayer(e.subLayers[0],t)},RemoveDataFromLayer:function(e,t){a.RemoveDataFromLayer(e.subLayers[0],t)},ClearLayer:function(e){a.ClearLayer(e.subLayers[0])},ShowLayer:c,HideLayer:function(e){r.HideLayer(e)},GetOverlayLayers:function(){return r.GetOverlayLayers()},GetBaseLayers:function(){return r.GetBaseLayers()},GetLayerById:d,GetFirstVisibleBaseLayer:function(){return r.GetVisibleBaseLayers()[0]},SetBaseLayer:f,SetStateFromUrlParams:function(e){a.ChangeView(e),e.layers&&e.layers.split(",").forEach(function(e){var t=d(e);t&&(!0===t.isBaseLayer?f(t):c(t))})},SetLayerOpacity:function(e,t){for(var n=e.subLayers,o=0;o<n.length;o++){var r=n[o];a.SetLayerOpacity(r,t)}a.RedrawMap()},MoveLayerToIndex:function(e,t){r.MoveLayerToIndex(e,t)},MoveLayerAbove:function(e,t){r.MoveLayerAbove(e,t)},MoveLayerToIndexInGroup:function(){r.MoveLayerToIndexInGroup()},GetCategoryById:function(e){return s.GetCategoryById(e)},GetCategories:function(){return s.GetCategories()},GetGroupById:function(e){return i.GetGroupById(e)},GetGroups:function(){return i.GetGroups()},RenderSync:function(){return a.RenderSync()},ExportMap:function(e){a.ExportMap(e)},ActivateExport:function(e){a.ActivateExport(e)},DeactivateExport:function(){a.DeactivateExport()},ActivateInfoClick:function(){a.ActivateInfoClick(p)},DeactivateInfoClick:function(){a.DeactivateInfoClick()},ShowHighlightedFeatures:function(e,t){a.ShowHighlightedFeatures(e,t)},ClearHighlightedFeatures:function(){a.ClearHighlightedFeatures()},SetHighlightStyle:function(e){a.SetHighlightStyle(e)},SetInfoMarker:function(e,t){o.SetInfoMarker(e,t)},SetImageInfoMarker:function(e){o.SetInfoMarkerPath(e),o.CreateDefaultInfoMarker()},GetSupportedGetFeatureInfoFormats:function(e,t){o.GetSupportedGetFeatureInfoFormats(e,t)},GetSupportedGetFeatureFormats:function(e,t){o.GetSupportedGetFeatureFormats(e,t)},RemoveInfoMarker:function(){o.RemoveInfoMarker()},RemoveInfoMarkers:function(){o.RemoveInfoMarkers()},ActivateBoxSelect:function(){a.ActivateBoxSelect(e)},DeactivateBoxSelect:function(){a.DeactivateBoxSelect()},GetFeatureCollection:function(e){return a.GetFeatureCollection(e)},GetFeaturesInMap:function(e){return a.GetFeaturesInMap(e)},GetFeatureExtent:function(e){return a.GetFeatureExtent(e)},InitEdit:function(e){return a.InitEdit(e)},ActivateEditClick:function(){a.ActivateEditSelect(m)},DeactivateEditClick:function(){a.DeactivateEditSelect()},UpdateFeature:function(e){a.UpdateFeature(e)},InsertFeature:function(e,t){return a.InsertFeature(e,t)},DeleteFeature:function(e){return a.DeleteFeature(e)},ActivateHoverInfo:function(){a.ActivateHoverInfo()},DeactivateHoverInfo:function(){a.DeactivateHoverInfo()},ActivateMeasure:function(e){a.ActivateMeasure(e)},DeactivateMeasure:function(){a.DeactivateMeasure()},InitOffline:function(){a.InitOffline()},ActivateOffline:function(){a.ActivateOffline()},StartCaching:function(e,t,n){a.StartCaching(e,t,n)},StopCaching:function(){a.StopCaching()},DeleteDatabase:function(e,t,n){a.DeleteDatabase(e,t,n)},CacheDatabaseExist:function(){return a.CacheDatabaseExist()},CalculateTileCount:function(e,t,n){return a.CalculateTileCount(e,t,n)},GetResource:function(e,t,n){a.GetResource(e,t,n)},GetConfigResource:function(e,t,n){a.GetConfigResource(e,t,n)},GetLayerResource:function(e,t,n){a.GetLayerResource(e,t,n)},DeactivateOffline:function(){a.DeactivateOffline()},GetResourceFromJson:function(e,t,n){a.GetResourceFromJson(e,t,n)},ActivateMeasureLine:function(e){a.ActivateMeasureLine(e)},DeactivateMeasureLine:function(){a.DeactivateMeasureLine()},ActivateAddLayerFeature:function(e){a.ActivateAddLayerFeature(e)},DeactivateAddLayerFeature:function(){a.DeactivateAddLayerFeature()},ActivateAddFeatureGps:function(e){a.ActivateAddFeatureGps(e)},AddCoordinatesGps:function(e){a.AddCoordinatesGps(e)},DeactivateAddFeatureGps:function(){a.DeactivateAddFeatureGps()},ActivateModifyFeature:function(e){a.ActivateModifyFeature(e)},DeactivateModifyFeature:function(){a.DeactivateModifyFeature()},ActivateDrawFeature:function(e){a.ActivateDrawFeature(e)},DeactivateDrawFeature:function(e){a.DeactivateDrawFeature(e)},ActivatePrintBoxSelect:function(e){a.ActivatePrintBoxSelect(e)},DeactivatePrintBoxSelect:function(){a.DeactivatePrintBoxSelect()},ActivateAddLayerUrl:function(e){a.ActivateAddLayerUrl(e)},DeactivateAddLayerUrl:function(){a.DeactivateAddLayerUrl()},ArrangeLayers:function(){(function(){if(l){var t=0;return l.layers.forEach(function(e){e.isVisible&&e.subLayers.forEach(function(){t++})}),t}})()===a.GetLayerCount()&&r.ArrangeLayers()},ConvertGmlToGeoJson:function(e){return a.ConvertGmlToGeoJson(e)},SetLegendGraphics:function(e){e.legendGraphicUrls=[];for(var t=0;t<e.subLayers.length;t++){var n=e.subLayers[t];e.isVisible&&(o=n,r.ShouldBeVisible(o))&&e.legendGraphicUrls.push(n.legendGraphicUrl)}var o},ExtentToGeoJson:function(e,t){a.ExtentToGeoJson(e,t)},AddZoom:function(){a.AddZoom()},AddZoomSlider:function(){a.AddZoomSlider()},AddZoomToExtent:function(e){a.AddZoomToExtent(e)},AddScaleLine:function(){a.AddScaleLine()},ZoomToLayer:function(e){a.ZoomToLayer(e)},ZoomToLayers:function(e){a.ZoomToLayers(e)},FitExtent:function(e){a.FitExtent(e)},GetCenter:function(){return a.GetCenter()},SetCenter:function(e){return a.SetCenter(e)},GetZoom:function(){return a.GetZoom()},SetZoom:function(e){a.SetZoom(e)},GetRotation:function(){return a.GetRotation()},SetRotation:function(e,t){a.SetRotation(e,t)},GetEpsgCode:function(){return a.GetEpsgCode()},GetVectorLayers:function(e,t){return a.GetVectorLayers(e,t)},GetCenterFromExtent:function(e){return a.GetCenterFromExtent(e)},GetScale:function(){return a.GetScale()},ChangeView:function(e){a.ChangeView(e)},GetLegendStyles:function(e){return a.GetLegendStyles(e)},RedrawMap:function(){a.RedrawMap()},RefreshMap:function(){a.RefreshMap()},RefreshLayerByGuid:function(e,t){a.RefreshLayerByGuid(e,t)},ShowInfoMarker:function(e){o.ShowInfoMarker(e)},ShowInfoMarkers:function(e){o.ShowInfoMarkers(e)},GetExtent:function(){return a.GetExtent()},GetVisibleSubLayers:t,GetUrlObject:function(){return a.GetUrlObject()},GetGeolocation:function(){return a.GetGeolocation()},RemoveGeolocation:function(){return a.RemoveGeolocation()},InfoClickSimulation:function(e){p(e)},SetTranslateOptions:function(e){a.SetTranslateOptions(e)},TransformCoordinates:function(e,t,n){return a.TransformCoordinates(e,t,n)},TransformFromGeographic:function(e){return a.TransformFromGeographic(e)},TransformToGeographic:function(e){return a.TransformToGeographic(e)},DescribeFeature:function(e,t){a.DescribeFeature(e,t)},RemoveIsyToken:function(){a.RemoveIsyToken()},SetIsyToken:function(e){a.SetIsyToken(e)},ShowCustomMessage:function(e){a.ShowCustomMessage(e)}}},(ISY=ISY||{}).MapAPI=ISY.MapAPI||{},ISY.MapAPI.Parsers=ISY.MapAPI.Parsers||{},ISY.MapAPI.Parsers.Base=function(o){return{Parse:function(e){var t,n;if(void 0===e)return null;if(e.type)"FeatureCollection"===e.type&&(t="geoJson");else if(void 0!==e.length)1<=e.length&&(t="geoJson");else{if(-1<e.toLowerCase().indexOf("exception"))return n=e,void(new ISY.MapAPI.Parsers.Exception).Parse(n);if(-1<e.toLowerCase().indexOf("<?xml"))t="kartKlifNo";else{if(-1<e.toLowerCase().indexOf("<html"))return function(e){var t=e.indexOf("<table");if(-1<t){var n=e.substring(t,e.length),o=n.indexOf("</body>");return n=n.substring(0,o),xml.xmlToJSON(n)}return[]}(e);if(!(-1<e.toLowerCase().indexOf("msgmloutput")))return null;t="fisheryDirectory"}}return o.CreateParser(t).Parse(e)}}},(ISY=ISY||{}).MapAPI=ISY.MapAPI||{},ISY.MapAPI.Parsers=ISY.MapAPI.Parsers||{},ISY.MapAPI.Parsers.Exception=function(){return{Parse:function(e){throw e.replace(/(<([^>]+)>)/gi,"")}}},(ISY=ISY||{}).MapAPI=ISY.MapAPI||{},ISY.MapAPI.Parsers=ISY.MapAPI.Parsers||{},ISY.MapAPI.Parsers.Factory=function(n,o,r,a){return{CreateParser:function(e){var t;switch(e){case"geoJson":t=n;break;case"gml":t=o;break;case"kartKlifNo":t=r;break;case"fisheryDirectory":t=a}return t}}},(ISY=ISY||{}).MapAPI=ISY.MapAPI||{},ISY.MapAPI.Parsers=ISY.MapAPI.Parsers||{},ISY.MapAPI.Parsers.FiskeriDir=function(s){var l,u,c,f="insteadofgml";function d(e){for(var t=[],n=0;n<e.length;n++){var o=e[n],r=new ISY.Domain.FeatureResponse;r.attributes=p(o);var a=c[Object.keys(c)[0]].srsname,i=c[Object.keys(c)[0]][f+"coordinates"];i=i.replace(/ /g,","),r.crs=a,r.geometryObject=s.ExtentToGeoJson(l,u),t.push(r)}return t}function p(e){var t=[];for(var n in e)-1===n.toLocaleLowerCase().indexOf(f)?(t.push([n,e[n]]),"x"===n&&(l=e[n]),"y"===n&&(u=e[n])):c=e[n];return t}return{Parse:function(e){var t=[];e=(e=(e=e.replace(/:gml/g,"")).replace(/gml:/g,f)).replace(/s:x/g,"sx");var n=xml.xmlToJSON(e),o=n[Object.keys(n)[0]];for(var r in o){var a=o[r];if(a instanceof Object)for(var i in a){var s=a[i];s instanceof Array&&(t=d(s))}}return t}}},(ISY=ISY||{}).MapAPI=ISY.MapAPI||{},ISY.MapAPI.Parsers=ISY.MapAPI.Parsers||{},ISY.MapAPI.Parsers.GeoJSON=function(){function c(e){var t=[];for(var n in e)t.push([n,e[n]]);return t}return{Parse:function(e){var t,n=[];if(e.crs){var o=e.crs;o.properties.code?t=o.type+":"+o.properties.code:o.properties.name&&(t=o.properties.name.substring(o.properties.name.indexOf("EPSG"),o.properties.name.length))}if(void 0!==e.features)for(var r=e.features,a=0;a<r.length;a++){var i=r[a],s=new ISY.Domain.FeatureResponse;s.crs=t,s.geometryObject=i,s.attributes=c(i.properties),s.olFeature=i.olFeature,n.push(s)}else if(void 0!==e.length)for(var l=0;l<e.length;l++)if(void 0!==e[l].rows.length){var u=new ISY.Domain.FeatureResponse;u.crs="",u.geometryObject="",u.attributes=c(e[l].rows[0]),n.push(u)}return n}}},(ISY=ISY||{}).MapAPI=ISY.MapAPI||{},ISY.MapAPI.Parsers=ISY.MapAPI.Parsers||{},ISY.MapAPI.Parsers.GML=function(){return{Parse:function(e){console.log(e)}}},(ISY=ISY||{}).MapAPI=ISY.MapAPI||{},ISY.MapAPI.Parsers=ISY.MapAPI.Parsers||{},ISY.MapAPI.Parsers.KartKlifNo=function(){function i(e){var t=[];for(var n in e)t.push([n,e[n]]);return t}return{Parse:function(e){var t=[];e=e.replace(/:/g,"");var n=xml.xmlToJSON(e);if(n.featureinforesponse){var o=n.featureinforesponse;if(o.fields){var r=o.fields;if(r instanceof Array)for(var a=0;a<r.length;a++)t.push(r[a]);else t.push(r)}}return function(e){for(var t=[],n=0;n<e.length;n++){var o=new ISY.Domain.FeatureResponse;o.attributes=i(e[n]),t.push(o)}return t}(t)}}},(ISY=ISY||{}).MapAPI=ISY.MapAPI||{},ISY.MapAPI.Tools=ISY.MapAPI.Tools||{},ISY.MapAPI.Tools.Tool=function(e){var t={id:"",activate:function(){console.log("Not implemented")},deactivate:function(){console.log("Not implemented")},messageObject:[],description:"",isCommand:!1},n=$.extend({},t,e);return n.Extend=function(e){return n=$.extend(n,e)},n},(ISY=ISY||{}).MapAPI=ISY.MapAPI||{},ISY.MapAPI.Tools=ISY.MapAPI.Tools||{},ISY.MapAPI.Tools.ToolFactory=function(e,t){var o=[],r=[],n=e,a={};function i(e){for(var t=0;t<o.length;t++){var n=o[t];if(n.id===e)return n}return!1}return o=t.GetTools(),{AddTool:function(e){r.push(e)},GetAvailableTools:function(){for(var e=[],t=0;t<r.length;t++)e.push(r[t].id);return e},ActivateTool:function(e){for(var t=!1,n=0;n<r.length;n++){var o=r[n];o.deactivate(),o.id===e&&($.isEmptyObject(a)?o.activate():o.activate(a),t=o.isCommand)}return t},SetupTools:function(e){for(var t=0;t<e.length;t++){var n=i(e[t].id);n&&r.push(n)}},DeactivateTool:function(e){var t=i(e);t&&(a={},t.deactivate(n))},AdditionalToolOptions:function(e){a=e}}},(ISY=ISY||{}).MapAPI=ISY.MapAPI||{},ISY.MapAPI.Tools=ISY.MapAPI.Tools||{},ISY.MapAPI.Tools.Tools=function(t){var e=[],n={id:"PointSelect",description:"This tool activates a get feature info click on the map",activate:function(){t.ActivateInfoClick()},deactivate:function(){t.DeactivateInfoClick()},messageObject:[]},o=new ISY.MapAPI.Tools.Tool(n);e.push(o);var r=new ISY.MapAPI.Tools.Tool({id:"DefaultZoom",description:"This is the default tool",activate:function(){},deactivate:function(){},messageObject:[]});e.push(r);var a={id:"BoxSelect",description:"This tool activates box select functionality to the map",activate:function(){t.ActivateBoxSelect()},deactivate:function(){t.DeactivateBoxSelect()},messageObject:[]},i=new ISY.MapAPI.Tools.Tool(a);e.push(i);var s={id:"DrawFeature",description:"This tool lets the user draw a feature in the map",activate:function(e){t.ActivateDrawFeature(e)},deactivate:function(){t.DeactivateDrawFeature()},messageObject:[]},l=new ISY.MapAPI.Tools.Tool(s);e.push(l);var u={id:"ModifyFeature",description:"This tool lets the user modify feature in the map.",activate:function(e){t.ActivateModifyFeature(e)},deactivate:function(){t.DeactivateModifyFeature()},messageObject:[]},c=new ISY.MapAPI.Tools.Tool(u);e.push(c);var f={id:"AddLayerFeature",description:"This tool lets the user add feature to the map",activate:function(e){t.ActivateAddLayerFeature(e)},deactivate:function(){t.DeactivateAddLayerFeature()},messageObject:[]},d=new ISY.MapAPI.Tools.Tool(f);e.push(d);var p={id:"AddFeatureGps",description:"This tool lets the user add feature to the map with geolocation",activate:function(e){t.ActivateAddFeatureGps(e)},deactivate:function(){t.DeactivateAddFeatureGps()},messageObject:[]},m=new ISY.MapAPI.Tools.Tool(p);e.push(m);var g={id:"Measure",description:"This tool lets the user measure in the map",activate:function(e){t.ActivateMeasure(e)},deactivate:function(){t.DeactivateMeasure()},messageObject:[]},v=new ISY.MapAPI.Tools.Tool(g);e.push(v);var S={id:"MeasureLine",description:"This tool lets the user measure line in the map",activate:function(e){t.ActivateMeasureLine(e)},deactivate:function(){t.DeactivateMeasureLine()},messageObject:[]},y=new ISY.MapAPI.Tools.Tool(S);e.push(y);var h={id:"FeatureHoverInfo",description:"This tool allow user get info via mouse hover",activate:function(){t.ActivateHoverInfo()},deactivate:function(){t.DeactivateHoverInfo()},messageObject:[]},I=new ISY.MapAPI.Tools.Tool(h);e.push(I);var w={id:"FeatureEditor",description:"This tool allow user to edit features",activate:function(){t.ActivateEditClick()},deactivate:function(){t.DeactivateEditClick()},messageObject:[]},L=new ISY.MapAPI.Tools.Tool(w);e.push(L);var M={id:"PrintBoxSelect",description:"This tool activates box select functionality for printing",activate:function(e){t.ActivatePrintBoxSelect(e)},deactivate:function(){t.DeactivatePrintBoxSelect()},messageObject:[]},C=new ISY.MapAPI.Tools.Tool(M);e.push(C);var b={id:"AddLayerUrl",description:"This tool lets the user add features from url to the map",activate:function(e){t.ActivateAddLayerUrl(e)},deactivate:function(){t.DeactivateAddLayerUrl()},messageObject:[]},x=new ISY.MapAPI.Tools.Tool(b);return e.push(x),{GetTools:function(){return e}}},(ISY=ISY||{}).MapImplementation=ISY.MapImplementation||{},ISY.MapImplementation.OL3=ISY.MapImplementation.OL3||{},ISY.MapImplementation.OL3.AddFeatureGps=function(o){var n,r,a,i,s,l,u,c,f,d,p,m=!1,g=!1,v=function(e){if(m){var t=n.add_layer_start_drawing;i&&!g&&(t=n.add_layer_continue_drawing),g&&(t=n.add_layer_modify_object),s.innerHTML=t,l.setPosition(e.coordinate),$(s).removeClass("hidden")}};function S(n){var e=new ol.source.Vector,t=new ISY.MapImplementation.OL3.Styles.Measure;"Line"===r&&(r="LineString"),u=new ol.interaction.Draw({source:e,style:t.Styles(),type:r}),c=new ol.layer.Vector({source:e,style:t.DrawStyles()}),n.addInteraction(u),n.addLayer(c),y(n),function(e){s&&null!==s.parentNode&&s.parentNode.removeChild(s);(s=document.createElement("div")).className="tooltip hidden",l=new ol.Overlay({element:s,offset:[15,0],positioning:"center-left"}),e.addOverlay(l)}(n),u.on("drawstart",function(e){i=e.feature,p=i.getGeometry().on("change",function(e){var t,n=e.target;n instanceof ol.geom.Polygon?(t="",e.coordinate=n.getInteriorPoint().getCoordinates()):n instanceof ol.geom.LineString&&(t="",e.coordinate=n.getLastCoordinate()),o.TriggerEvent(ISY.Events.EventTypes.MeasureMouseMove,t)})},this),u.on("drawend",function(e){n.removeInteraction(d),i=null,ol.Observable.unByKey(p),i=e.feature;var t=new ol.Collection([i]);f=new ol.interaction.Modify({features:t,deleteCondition:function(e){return ol.events.condition.shiftKeyOnly(e)&&ol.events.condition.singleClick(e)}}),n.addInteraction(f),y(n),o.TriggerEvent(ISY.Events.EventTypes.AddLayerFeatureEnd,i),g=!0,f.on("modifyend",function(e){ol.Observable.unByKey(p),i=e.features.getArray()[0],o.TriggerEvent(ISY.Events.EventTypes.AddLayerFeatureEnd,i)},this),n.removeInteraction(u)},this)}function y(e){var t=new ol.Collection(a);d=new ol.interaction.Snap({features:t}),e.addInteraction(d)}return{Activate:function(e,t){m=!0,n=t.translate,r=t.toolType,a=t.snappingFeatures,e.on("pointermove",v),$(e.getViewport()).on("mouseout",function(){$(s).addClass("hidden")}),S(e)},AddCoordinates:function(e){return e},Deactivate:function(e){m&&(g=m=!1,i=null,void 0!==e&&(e.removeLayer(c),e.removeInteraction(f),e.removeInteraction(d),function(e){e.removeInteraction(u),e.removeOverlay(l),null!==s&&null!==s.parentNode&&s.parentNode.removeChild(s);for(var t=document.getElementsByClassName("tooltip tooltip-static");0<t.length;){var n=t[0];n.parentNode.removeChild(n)}}(e)))}}},(ISY=ISY||{}).MapImplementation=ISY.MapImplementation||{},ISY.MapImplementation.OL3=ISY.MapImplementation.OL3||{},ISY.MapImplementation.OL3.AddLayerFeature=function(r){var a,i,s,l,u,c,f,d,p=!1,m=new ol.source.Vector,e="rgba(0,0,0,255)",t="rgba(255,255,0,255)",g=[new ol.style.Style({stroke:new ol.style.Stroke({color:e,width:3}),image:new ol.style.Circle({radius:5,fill:new ol.style.Fill({color:e}),stroke:new ol.style.Stroke({color:t,width:2})})}),new ol.style.Style({stroke:new ol.style.Stroke({color:t,width:3,lineDash:[15,30]})})];function v(e){var t=new ol.Collection(i);f=new ol.interaction.Snap({features:t}),e.addInteraction(f)}var S=function(t){t.getInteractions().forEach(function(e){e instanceof ol.interaction.DoubleClickZoom&&t.removeInteraction(e)})};return{Activate:function(e,t){var n;if(p=!0,translate=t.translate,a=t.toolType,i=t.snappingFeatures,d=function(t,e){if(e){var n=new ol.format.GPX({dataProjection:"EPSG:4326",featureProjection:t.getView().getProjection()}).readFeatures(e);n.forEach(function(e){e.getGeometry().transform("EPSG:4326",t.getView().getProjection())});var o=new ol.Collection(n);return m=new ol.source.Vector({features:o}),n}}(e,t.features),n=e,u=new ol.layer.Vector({source:m,style:g}),n.addLayer(u),d){e.removeInteraction(l);var o=d[0].getGeometry().getExtent();e.getView().fit(o,e.getSize())}else!function(n){"Line"===a&&(a="LineString"),l=new ol.interaction.Draw({source:m,style:g,type:a}),n.addInteraction(l),v(n),l.on("drawend",function(e){n.removeInteraction(f),s=e.feature;var t=new ol.Collection([s]);c=new ol.interaction.Modify({features:t}),n.addInteraction(c),v(n),r.TriggerEvent(ISY.Events.EventTypes.AddLayerFeatureEnd,s),startModify=!0,c.on("modifyend",function(e){s=e.features.getArray()[0],r.TriggerEvent(ISY.Events.EventTypes.AddLayerFeatureEnd,s)},this),n.removeInteraction(l)},this)}(e);S(e)},Deactivate:function(e){var t;S(t=e),t.addInteraction(new ol.interaction.DoubleClickZoom),p&&(p=!1,startModify=!1,s=null,void 0!==e&&(e.removeLayer(u),e.removeInteraction(c),e.removeInteraction(f),e.removeInteraction(l),m=new ol.source.Vector))}}},(ISY=ISY||{}).MapImplementation=ISY.MapImplementation||{},ISY.MapImplementation.OL3=ISY.MapImplementation.OL3||{},ISY.MapImplementation.OL3.AddLayerUrl=function(r){var a,i,s,l=!1,u=new ol.source.Vector,c="propertyMarking";function f(){l&&(l=!1)}return{Activate:function(e,t){if(!t.show)return e.removeLayer(i),void f();var n,o;l=!0,a=e.getView().getProjection(),s=t.style?t.style:defaultStyle,u=function(n,o){return n.url&&(u=new ol.source.Vector({format:new ol.format.GML,url:n.url})).on("addfeature",function(e){n.geometryName&&e.feature.setGeometryName(n.geometryName),e.feature.getGeometry().transform("EPSG:4326",a);var t=u.getExtent();o.getView().fit(t,o.getSize()),r.TriggerEvent(ISY.Events.EventTypes.AddLayerUrlEnd,!0)},this),u}(t,e),(n=e).getLayers().forEach(function(e){e.get("id")===c&&n.removeLayer(e)}),o=e,(i=new ol.layer.Vector({source:u,style:s})).set("id",c),o.addLayer(i)},Deactivate:f}},(ISY=ISY||{}).MapImplementation=ISY.MapImplementation||{},ISY.MapImplementation.OL3=ISY.MapImplementation.OL3||{},ISY.MapImplementation.OL3.DrawFeature=function(s){var d,l,u,c,f,p,r,a,m,g,v,S,y={modify:[],source:[],select:[],draw:[]},h=!1,I=!1,w=!1,L=new ol.Sphere(6378137),M=new ol.format.GeoJSON({defaultDataProjection:"EPSG:25833",projection:"EPSG:25833"}),C=new ol.Collection,b=new ol.source.Vector({features:C}),x=new ISY.MapImplementation.OL3.Styles.Measure,E=new ISY.MapImplementation.OL3.Styles.Json,o=new ISY.Utils.Guid;function Y(e,n){var t;N(t=n),(r=document.createElement("div")).className="tooltip tooltip-measure",a=new ol.Overlay({element:r,offset:[0,-15],positioning:"bottom-center"}),t.addOverlay(a);var o=e.feature||e.features.getArray()[0];o.getGeometry().on("change",function(e){var t=G(e.target,n);o.setProperties({measurement:t}),r.innerHTML=t,a.setPosition(function(e){{if(e instanceof ol.geom.Polygon)return e.getInteriorPoint().getCoordinates();if(e instanceof ol.geom.LineString)return e.getLastCoordinate()}}(e.target))})}function G(e,t){return e instanceof ol.geom.Polygon?R(t,e):e instanceof ol.geom.LineString?i(t,e):void 0}function O(e){var t,n="rgb(128, 128, 255)";E.GetStyle(e);var o,r,a,i,s,l,u,c,f=e.getStyle();switch(f||(f=d),f.length&&(f=f[0]),e.getGeometry().getType()){case"Point":l=n,t=(s=f).getText()?[(u=s,c=l,new ol.style.Style({text:new ol.style.Text({font:u.getText().getFont(),text:u.getText().getText(),stroke:new ol.style.Stroke({color:c,width:u.getText().getStroke().getWidth()+5}),fill:u.getText().getFill()})})),s]:[new ol.style.Style({image:new ol.style.RegularShape({fill:new ol.style.Fill({color:l}),radius:s.getImage().getRadius()+3,points:s.getImage().getPoints()})}),s];break;case"LineString":a=f,i=n,t=[new ol.style.Style({stroke:new ol.style.Stroke({color:i,lineDash:a.getStroke().getLineDash(),width:a.getStroke().getWidth()+5})}),a];break;case"Polygon":o=f,r=n,t=[new ol.style.Style({fill:o.getFill(),stroke:new ol.style.Stroke({color:r,width:7})})]}e.setStyle(t)}function n(e,t){for(var n=0;n<y[t].length;n++)ol.Observable.unByKey(y[t][n])}function T(){if(function(e){for(var t=0;t<e.length;t++){var n=e[t];n.getId()||n.setId(o.NewGuid()),n.getProperties().style||k(n)}}(C.getArray()),!w){var e=JSON.parse(M.writeFeatures(b.getFeatures()));reusltJson=U("EPSG:4326",e),reusltJson=JSON.stringify(e),s.TriggerEvent(ISY.Events.EventTypes.DrawFeatureEnd,reusltJson)}}var P=function(){return h&&""===d.getText().getText()};function F(e){c=new ol.interaction.Modify({features:p.getFeatures(),condition:function(e){return A(e)},deleteCondition:function(e){return t=e,ol.events.condition.shiftKeyOnly(t)&&"pointerdown"===t.type;var t}}),e.addInteraction(c)}function A(e){return"pointerdown"===e.type&&ol.events.condition.noModifierKeys(e)}function D(e){C=new ol.Collection(e),b=new ol.source.Vector({features:C}),(m=new ol.layer.Vector({source:b,style:t})).set("id","drawing")}function k(e){switch(e.getGeometry().getType()){case"Point":!function(e){var t;t=""!==d.getText().getText()?{style:{text:function(){var e={font:d.getText().getFont(),text:d.getText().getText(),fill:{color:d.getText().getFill().getColor()}};d.getText().getStroke()&&(e.stroke={color:d.getText().getStroke().getColor(),width:d.getText().getStroke().getWidth()});return e}()}}:{style:{regularshape:{fill:{color:d.getImage().getFill().getColor()},points:d.getImage().getPoints(),radius:d.getImage().getRadius()}}};e.setProperties(t)}(e);break;case"LineString":e.setProperties({style:{stroke:{color:d.getStroke().getColor(),lineDash:d.getStroke().getLineDash(),width:d.getStroke().getWidth()}}});break;case"Polygon":e.setProperties({style:{fill:{color:d.getFill().getColor()},stroke:{color:(t=d.getFill().getColor(),t.replace(","+t.split(",")[3],")").replace("rgba","rgb")),width:2}}})}var t}function t(e){if(E.GetStyle(e),S){var t=e.getProperties().measurement;switch(e.getGeometry().getType()){case"Point":return;case"LineString":return s=t,l=(i=e).getStyle()[0],u=new ol.style.Style({stroke:l.getStroke(),text:new ol.style.Text({font:d.getText().font,text:s,fill:new ol.style.Fill({color:"#000000"}),stroke:new ol.style.Stroke({color:"rgba(255,255,255,1)",width:10})})}),i.setStyle(u),u;case"Polygon":return o=t,r=(n=e).getStyle()[0],a=new ol.style.Style({fill:r.getFill(),stroke:r.getStroke(),text:new ol.style.Text({font:d.getText().font,text:function(e){var t=document.createElement("span");t.innerHTML=e;for(var n=0;n<t.children.length;n++){var o=t.children[n];"SUP"===o.tagName&&(o.textContent<=3&&1<o.textContent?o.textContent=String.fromCharCode(o.textContent.charCodeAt(0)+128):3<o.textContent&&o.textContent<=9&&(o.textContent=String.fromCharCode(o.textContent.charCodeAt(0)+8256)))}return t.textContent}(o),fill:new ol.style.Fill({color:"#000000"}),stroke:new ol.style.Stroke({color:"rgba(255,255,255,1)",width:10})})}),n.setStyle(a),a}}var n,o,r,a,i,s,l,u}var i=function(e,t){var n,o=t.getCoordinates();n=0;for(var r=e.getView().getProjection(),a=0,i=o.length-1;a<i;++a){var s=ol.proj.transform(o[a],r,"EPSG:4326"),l=ol.proj.transform(o[a+1],r,"EPSG:4326");n+=L.haversineDistance(s,l)}return n<1e3?n.toFixed(2)+" m":(n/1e3).toFixed(3)+" km"},R=function(e,t){var n,o=e.getView().getProjection(),r=t.clone().transform(o,"EPSG:4326").getLinearRing(0).getCoordinates();return(n=Math.abs(L.geodesicArea(r)))<1e4?Math.round(n)+" m&sup2;":(n/1e6).toFixed(4)+" km&sup2;"};function N(e){r&&r.parentNode&&r.parentNode.removeChild(r),e.removeOverlay(a)}var j=function(t){t.getInteractions().forEach(function(e){e instanceof ol.interaction.DoubleClickZoom&&t.removeInteraction(e)})};function V(e,t){switch(e){case"EPSG:4326":90<t[1]&&(t=proj4("EPSG:32633","EPSG:4326",t));break;case"EPSG:32633":t[1]<90&&(t=proj4("EPSG:4326","EPSG:32633",t))}return t}function U(e,t){for(var n=0;n<t.features.length;n++){var o=t.features[n].geometry.coordinates;if(2===o.length&&"number"==typeof o[0])t.features[n].geometry.coordinates=V(e,o);else for(var r=0;r<o.length;r++)t.features[n].geometry.coordinates[r]=V(e,o[r])}return t}return{Activate:function(t,e){switch(h=!(I=!0),S=e.showMeasurements,d=e.style||d?e.style:x.Styles(),e.GeoJSON?"remove"===e.GeoJSON?D():e.deleteFeature&&e.selectedFeatureId?(b.removeFeature(b.getFeatureById(e.selectedFeatureId)),v=g=void 0,D(C.getArray()),s.TriggerEvent(ISY.Events.EventTypes.DrawFeatureEnd,M.writeFeatures(b.getFeatures()))):(e.GeoJSON="object"==typeof e.GeoJSON?e.GeoJSON:JSON.parse(e.GeoJSON),e.GeoJSON=U("EPSG:32633",e.GeoJSON),D(M.readFeatures(e.GeoJSON))):D(),!e.deleteFeature&&e.selectedFeatureId?e.selectionActive&&(g=e.selectedFeatureId,k(v=b.getFeatureById(g)),O(v)):v=g=void 0,t.getLayers().forEach(function(e){void 0!==e&&"drawing"===e.get("id")&&t.removeLayer(e)}),t.addLayer(m),e.mode){case"modify":r=t,a={condition:ol.events.condition.click,layers:[m]},v&&(a.features=[v]),p=new ol.interaction.Select(a),r.addInteraction(p),F(t);break;case"draw":"Active"!==e.type&&(l=e.type),"Text"===e.type&&(l="Point",h=!0),n=t,o=l,u&&u.type===o||(u=new ol.interaction.Draw({source:b,type:o,condition:function(e){return A(e)&&!w&&!P()}}),n.addInteraction(u))}var n,o,r,a,i;e.snap&&(i=t,f=new ol.interaction.Snap({source:b}),i.addInteraction(f)),function(n,e){b&&(y.source.push(b.on("addfeature",function(){T()},this)),y.source.push(b.on("removefeature",function(){T()},this))),c&&(y.modify.push(c.on("modifystart",function(){w=!0},this)),y.modify.push(c.on("modifyend",function(e){var t=e.features.getArray()[0];t.setProperties({measurement:G(t.getGeometry(),n)}),w=!1,T()},this))),p&&y.select.push(p.on("select",function(e){var t=e.selected;1===t.length&&s.TriggerEvent(ISY.Events.EventTypes.DrawFeatureSelect,t[0].getId())},this)),e&&(y.draw.push(u.on("drawstart",function(e){Y(e,n)},this)),y.draw.push(u.on("drawend",function(){N(n)},this)),c&&(y.modify.push(c.on("modifystart",function(e){Y(e,n)},this)),y.modify.push(c.on("modifyend",function(){N(n)},this)))),y.draw.push(u.on("drawstart",function(){j(n)})),y.draw.push(u.on("drawend",function(e){e.feature.setProperties({measurement:G(e.feature.getGeometry(),n)})}))}(t,e.showMeasurements),T()},Deactivate:function(e){var t;I&&(I=!1,void 0!==e&&(e.removeInteraction(u),e.removeInteraction(c),e.removeInteraction(f),e.removeInteraction(p),n(0,"modify"),n(0,"source"),n(0,"select"),n(0,"draw"),j(t=e),t.addInteraction(new ol.interaction.DoubleClickZoom)))}}},(ISY=ISY||{}).MapImplementation=ISY.MapImplementation||{},ISY.MapImplementation.OL3=ISY.MapImplementation.OL3||{},ISY.MapImplementation.OL3.Export=function(){var o,a,i="",r=!1;function s(e){var t,n,o=210/297,r=e.getSize();"a4portrait"===i.value?t=(n=r[1]*o)>r[0]?(n=r[0],r[0]/o):r[1]:n=(t=r[0]*o)>r[1]?(t=r[1],r[1]/o):r[0];var a=[r[0]*ol.has.DEVICE_PIXEL_RATIO/2,r[1]*ol.has.DEVICE_PIXEL_RATIO/2];return{minx:a[0]-n/2,miny:a[1]-t/2,maxx:a[0]+n/2,maxy:a[1]+t/2}}var l=function(e){e.context.save()},u=function(e){var t,n,o=e.context,r=(t=e.target,{height:(n=t.getSize())[1]*ol.has.DEVICE_PIXEL_RATIO,width:n[0]*ol.has.DEVICE_PIXEL_RATIO});o.beginPath(),o.moveTo(0,0),o.lineTo(r.width,0),o.lineTo(r.width,r.height),o.lineTo(0,r.height),o.lineTo(0,0),o.closePath(),o.moveTo(a.minx,a.miny),o.lineTo(a.minx,a.maxy),o.lineTo(a.maxx,a.maxy),o.lineTo(a.maxx,a.miny),o.lineTo(a.minx,a.miny),o.closePath(),o.fillStyle="rgba(25, 25, 25, 0.75)",o.fill(),o.restore()};return{Activate:function(e,t,n){i=e.layout,r=!0,a=s(t),o=[t.on("precompose",l),t.on("postcompose",u)],n()},Deactivate:function(e){if(r=!1,o){for(var t=0;t<o.length;t++)ol.Observable.unByKey(o[t]);e()}},ExportMap:function(n,e){e.once("postcompose",function(e){var t=e.context.canvas;n(t,a)})},WindowResized:function(e){r&&(a=s(e),e.render())}}},(ISY=ISY||{}).MapImplementation=ISY.MapImplementation||{},ISY.MapImplementation.OL3=ISY.MapImplementation.OL3||{},ISY.MapImplementation.OL3.Sources=ISY.MapImplementation.OL3.Sources||{},ISY.MapImplementation.OL3.FeatureEditor=function(i){var n="",o=[],s="",l=null;return{Init:function(e,t,n,o,r,a){void 0===n&&(n="http://kart4.nois.no/skjema/va"),l=new ISY.MapImplementation.OL3.Sources.WfsT(e,t,n,o,r,i),s=a},ActivateEditSelect:function(t,e){void 0!==e&&(n=e.on("singleclick",function(e){t(e.coordinate)}))},DeactivateEditSelect:function(){ol.Observable.unByKey(n),n=""},HandlePointSelect:function(e){var t=new ol.geom.Point(e);o.push(t);var n=new ol.Feature({navn:"ISY.MapLib-"+l.GetFeatureType()+"-Insert"});n.setGeometryName(s),n.setGeometry(t),l.InsertFeature(n)},UpdateFeature:function(e){l.UpdateFeature(e)},InsertFeature:function(e,t){return l.InsertFeature(e,t)},DeleteFeature:function(e){return l.DeleteFeature(e)}}},(ISY=ISY||{}).MapImplementation=ISY.MapImplementation||{},ISY.MapImplementation.OL3=ISY.MapImplementation.OL3||{},ISY.MapImplementation.OL3.FeatureInfo=function(){var n,i,s=null,l=null,o="",u=[];function c(){null!==s&&s.getSource().clear()}function f(e){return new t(e.split(":"))}function t(e){this.type=e[0],this.properties=new r(e[1])}function r(e){this.code=e}return{ShowHighlightedFeatures:function(e,t){!function(e){if(null===s){null===l&&(n=new ISY.MapImplementation.OL3.Styles.Default,l=n.Styles);var t=new ol.source.Vector({projection:"EPSG:4326",object:{type:"FeatureCollection",totalFeatures:1,features:[{type:"Feature",id:"thc.1",geometry:{type:"Point",coordinates:[21.7495,71.721]},geometry_name:"the_geom",properties:{Year:2003}}],crs:{type:"EPSG",properties:{code:"4326"}}}});s=new ol.layer.Vector({source:t,style:l}),e.addLayer(s)}else e.removeLayer(s),e.addLayer(s);var n}(t),c();for(var n=new ol.format.GeoJSON,o=0;o<e.length;o++){var r=e[o];if(void 0!==r.geometryObject){var a=n.readFeature(r.geometryObject);r.crs&&a.getGeometry().transform(ol.proj.get(r.crs),ol.proj.get(t.getView().getProjection().getCode())),r.hoverstyle&&a.setStyle(r.hoverstyle),s.getSource().addFeature(a)}else s.getSource().addFeature(r)}},ClearHighlightedFeatures:c,SetHighlightStyle:function(e){l=e,s.setStyle(l)},ShowInfoMarker:function(e,t,n){var o=$(t),r=o[0].height,a=o[0].width;(i=new ol.Overlay({element:t,stopEvent:!1,offset:[-a/2,-r]})).setPosition(e),n.addOverlay(i)},ShowInfoMarkers:function(e,t,n){for(var o=0;o<e.length;o++){var r=document.createElement("img");r.src="assets/img/pin-md-blueish.png",r.style.visibility="visible";var a=0,i=0,s=$(t);0!==s[0].height&&0!==s[0].width&&(a=s[0].width,i=s[0].height);var l=new ol.Overlay({element:r,stopEvent:!1,offset:[-a/2,-i]});l.setPosition(e[o]),n.addOverlay(l),u.push(l)}},RemoveInfoMarker:function(e,t){void 0!==i&&t.removeOverlay(i)},RemoveInfoMarkers:function(e,t){if(void 0!==u)for(var n=0;n<u.length;n++)t.removeOverlay(u[n])},GetFeatureInfoUrl:function(e,t,n,o){var r=o.getResolution(),a=t.getSource(),i=o.getProjection(),s=a.getGetFeatureInfoUrl(n,r,i,{INFO_FORMAT:e.featureInfo.getFeatureInfoFormat,feature_count:10}),l=decodeURIComponent(s),u=l.substring(l.lastIndexOf("?"),l.length).replace("?",""),c=encodeURIComponent(u);return e.url[0]+"?"+c},ActivateInfoClick:function(t,e){void 0!==e&&(o=e.on("singleclick",function(e){t(e.coordinate)}))},DeactivateInfoClick:function(){ol.Observable.unByKey(o),o=""},ActivateBoxSelect:function(e,t){n=new ol.interaction.DragBox({condition:ol.events.condition.always}),t.addInteraction(n),n.on("boxend",function(){e(n.getGeometry().getExtent())})},DeactivateBoxSelect:function(e){void 0!==e&&e.removeInteraction(n)},GetFeaturesInExtent:function(o,e,t){if(void 0!==e&&void 0!==o&&function(e,t){var n=e.getMinResolution();if(0<n&&t<n)return!1;var o=e.getMaxResolution();return!(o!==1/0&&o<t)}(e,t)){var n=e.getSource(),r=[];n.forEachFeatureInExtent(o,function(e){var t=e.getGeometry(),n=e.get("isHidden");(n=void 0!==n&&n)||void 0!==t&&t.intersectsExtent(o)&&r.push(e)});var a=(new ol.format.GeoJSON).writeFeaturesObject(r);if(Array.isArray(a.features))for(var i=0;i<a.features.length;i++)a.features[i].olFeature=r[i];else a.features.olFeature=Array.isArray(r)?r[0]:r;var s=n.getProjection();return s&&(a.crs=f(s.getCode())),a}},GetExtentForCoordinate:function(e,t,n){var o=t*n,r=e[0],a=e[1];return[r-o,a-o,r+o,a+o]},GetFeatureCollection:function(e){if(null!==e){var t=e.getSource(),n=t.getFeatures(),o=(new ol.format.GeoJSON).writeFeaturesObject(n);return t.getProjection()&&(o.crs=f(t.getProjection().getCode())),o}},GetFeatureExtent:function(e){return(new ol.format.GeoJSON).readFeature(e.geometryObject).getGeometry().getExtent()},GetFeaturesInMap:function(e){if(null!==e)return e.getSource().getFeatures()}}},(ISY=ISY||{}).MapImplementation=ISY.MapImplementation||{},ISY.MapImplementation.OL3=ISY.MapImplementation.OL3||{},ISY.MapImplementation.OL3.HoverInfo=function(){var a,m,g,v,S,y,i=!1,h=1,s=!1,l=!1,u=!1;function t(e,t){return e.zindex<t.zindex?1:e.zindex>t.zindex?-1:0}function I(e){if(0!==e.length)return e.sort(t),e}function c(e,t){var n,o,r;switch(h){case 1:n=t;break;case 2:n=t.originalEvent,r=e.getEventPixel(n)}switch(h){case 1:o=function(e){var o=[];if(e.forEach(function(e){var t=m.GetLayerByFeature(e);if(t){var n=parseInt(t.guid,10);o.push({feature:e,zindex:n})}}),void 0!==(o=I(o)))return o[0].feature}(n.target.getFeatures().getArray());break;case 2:o=function(e,t){var n=[];if(e.forEachFeatureAtPixel(t,function(e){var t=parseInt(m.GetLayerByFeature(e).guid,10);n.push({feature:e,zindex:t})}),void 0!==(n=I(n)))return n[0].feature}(e,r)}void 0===S&&(S=new ol.Overlay({element:document.getElementById("popup")}),e.addOverlay(S));var a=S.getElement();if(o){if(void 0!==o.getProperties()){var i;switch(h){case 1:i=y;break;case 2:i=t.coordinate}$(a).popover("destroy"),S.setPosition(i);var s="",l=m.GetLayerByFeature(o).tooltipTemplate;if(l){for(var u,c,f,d="",p=l.indexOf("{");0<=p;)0<p&&(d+=l.substr(0,p),p=(l=l.slice(p)).indexOf("{")),f=l.indexOf("}"),u=l.substr(p+1,f-p-1),(c=o.get(u))&&(d+=c),p=(l=l.slice(f+1)).indexOf("{");s=d+l}0<s.length?($(a).popover({placement:"top",animation:!1,html:!0,content:'<div class="hover-info">'+s+"</div>"}),$(a).popover("show")):$(a).popover("destroy")}}else $(a).popover("destroy");o!==v&&(v&&g.getSource().removeFeature(v),o&&g.getSource().addFeature(o),v=o)}function f(e,t){return m.GetHoverStyle(e,t)}return{ActivateHoverInfo:function(e,t,n,o){var r;m=n,(r=o)&&r.multiSelect&&(i=r.multiSelect),function(o){if(!s)if(s=!0,l)switch(h){case 1:o.addInteraction(a),a.setActive(!0)}else switch(l=!0,g=new ol.layer.Vector({map:o,source:new ol.source.Vector({useSpatialIndex:!1}),style:f,updateWhileAnimating:!0,updateWhileInteracting:!0}),h){case 1:a=new ol.interaction.Select({condition:ol.events.condition.pointerMove,multi:i,style:function(e,t){return m.GetHoverStyle(e,t)}}),o.addInteraction(a),a.on("select",function(e){s&&(e.dragging||c(o,e))}),u||(u=!0,o.on("pointermove",function(e){var t,n;t=o,n=e,s&&(mousePixel=t.getEventPixel(n.originalEvent),y=n.coordinate,S&&S.setPosition(y))}));break;case 2:o.on("pointermove",function(e){s&&(e.dragging||c(o,e))})}}(e)},DeactivateHoverInfo:function(e){if(void 0!==e)switch(s=!1,function(){if(void 0!==S){var e=S.getElement();$(e).popover("destroy"),v&&g&&(g.getSource().removeFeature(v),v=void 0)}}(),h){case 1:a&&(a.setActive(!1),e.removeInteraction(a),a=void 0,l=!1)}}}},(ISY=ISY||{}).MapImplementation=ISY.MapImplementation||{},ISY.MapImplementation.OL3=ISY.MapImplementation.OL3||{},ISY.MapImplementation.OL3.Map=function(e,l,t,n,o,r,a,i,s,u,c,f,d,p,m){var g,v,S,y,h,I,w,L,M,C,b,x,E,Y=[],G=[],O=[],T=new ISY.MapImplementation.OL3.FeatureEditor(l),P=!1,F="",A="",D="",k=3e3,R=3e3,N=0,V=0,U=0,_=0;function B(){var a=(new Date).getTime();if(a<N+6e4){return}if(N=a,g.getLayers()){g.getLayers().forEach(function(e){var t=e.getSource();if(t&&t.getParams){var n=t.getParams();if(n&&n.GKT){var o=t.get("timestamp");if(o){var r=Math.round((a-o)/1e3);if(r>k){z(t)}}}}})}}function W(){var a=(new Date).getTime();if(a<V+6e4){return}if(V=a,g.getLayers()){g.getLayers().forEach(function(e){var t=e.getSource();if(t&&t.getParams){var n=t.getParams();if(n&&n.ticket){var o=t.get("timestamp");if(o){var r=Math.round((a-o)/1e3);if(r>R){H(t)}}}}})}}function z(e){e.updateParams({GKT:X()}),e.set("timestamp",(new Date).getTime())}function H(e){e.updateParams({ticket:function(){{if(!D)return null;I&&!function(){var e=(new Date).getTime();if(e<_+1e3*R)return _=e,!1;return!0}()||(I=$.ajax({type:"GET",url:D,async:!1}).responseText.trim().replace(/"/g,""),_=(new Date).getTime())}return I}()}),e.set("timestamp",(new Date).getTime())}function J(t){var n=!1;return g.getLayers().forEach(function(e){n||e.guid!==t.id||(n=!0)}),n}function Z(e,t){if(Array.isArray(e)&&(e=e[0]),t)return Array.isArray(F)?F[0]+e:F+e;if(!Array.isArray(F))return F+e;for(var n=[],o=0;o<F.length;o++)n.push(F[o]+e);return n}function X(){return A?(h&&!function(){var e=(new Date).getTime();if(e<U+1e3*k)return U=e,!1;return!0}()||(h=$.ajax({type:"GET",url:A,async:!1}).responseText.trim().replace(/"/g,""),U=(new Date).getTime()),h):null}function K(e,t){e.set("config",t),e.on("change",function(){e.set("loading",!0)},e),e.on("render",function(){e.get("loading")&&(e.set("loading",void 0),l.TriggerEvent(ISY.Events.EventTypes.LoadingLayerEnd,e))},e)}function q(n){var o,e,t,r=ne(n),a=!0;M&&0<M.length&&(t={isyToken:M});var i=function(e){o.set("config",n);var t=O[n.id].ParseSld(e,parseInt(n.id,10));t.maxScaleDenominator&&ee(o,ie(t.maxScaleDenominator)),t.minScaleDenominator&&Q(o,ie(t.minScaleDenominator)),oe(n),Y.push(o),o.sortingIndex=n.sortingIndex,g.addLayer(o),l.TriggerEvent(ISY.Events.EventTypes.LayerCreated,Y),ce(),de()};if(null!==r)(o=r).set("config",n);else{switch(n.source){case ISY.Domain.SubLayer.SOURCES.wmts:!n.gatekeeper||!n.tiled||void 0!==u&&u.IsActive()||(t?t.gkt=X():t={gkt:X()}),e=new ISY.MapImplementation.OL3.Sources.Wmts(n,t);break;case ISY.Domain.SubLayer.SOURCES.proxyWmts:n.url=Z(n.url),e=new ISY.MapImplementation.OL3.Sources.Wmts(n,t);break;case ISY.Domain.SubLayer.SOURCES.wms:e=new ISY.MapImplementation.OL3.Sources.Wms(n,t),!n.gatekeeper||!n.tiled||void 0!==u&&u.IsActive()||z(e),!n.ticket||void 0!==u&&u.IsActive()||H(e);break;case ISY.Domain.SubLayer.SOURCES.proxyWms:n.url=Z(n.url),e=new ISY.MapImplementation.OL3.Sources.Wms(n,t);break;case ISY.Domain.SubLayer.SOURCES.vector:e=new ISY.MapImplementation.OL3.Sources.Vector(n),""!==n.url&&(n.noProxy||(n.url=Z(n.url)));break;case ISY.Domain.SubLayer.SOURCES.wfs:n.noProxy||(n.url=Z(n.url,!0)),e=new ISY.MapImplementation.OL3.Sources.Wfs(n,u,t);break;default:throw"Unsupported source: ISY.Domain.SubLayer.SOURCES.'"+n.source+"'. For SubLayer with url "+n.url+" and name "+n.name+"."}n.source===ISY.Domain.SubLayer.SOURCES.vector?n.style?"object"==typeof n.style||n.style.indexOf("http")<0?(O[n.id]=new ISY.MapImplementation.OL3.Styles.Json(n.style),o=new ol.layer.Vector({source:e,style:function(e,t){return O[n.id].GetStyle(e,ae(t))}})):(O[n.id]=new ISY.MapImplementation.OL3.Styles.Sld,o=new ol.layer.Vector({source:e,style:function(e,t){return O[n.id].GetStyle(e,ae(t))}}),n.style&&(a=!1,ye(n.style,"application/xml",i)),K(o,n)):o=new ol.layer.Vector({source:new ol.source.Vector({format:new ol.format.GeoJSON({defaultDataProjection:n.coordinate_system}),url:n.url})}):n.source===ISY.Domain.SubLayer.SOURCES.wfs?(O[n.id]=new ISY.MapImplementation.OL3.Styles.Sld,o=new ol.layer.Vector({source:e,style:function(e,t){return O[n.id].GetStyle(e,ae(t))}}),n.style&&(a=!1,ye(n.style,"application/xml",i)),K(o,n)):o=n.tiled?new ol.layer.Tile({extent:n.extent,opacity:n.opacity,source:e}):new ol.layer.Image({extent:n.extent,opacity:n.opacity,source:e}),o.set("config",n),o.layerIndex=n.layerIndex,o.guid=n.id,o.typename=n.name,o.tooltipTemplate=n.tooltipTemplate,void 0!==n.minResolution&&o.setMinResolution(n.minResolution),void 0!==n.maxResolution&&o.setMaxResolution(n.maxResolution),n.maxScale&&Q(o,ie(n.maxScale)),n.minScale&&ee(o,ie(n.minScale)),a&&(oe(n),Y.push(o))}if(a)return o}function Q(e,t){if(e&&t){var n=e.getMinResolution();if(n&&t<=n)return;e.setMinResolution(t)}}function ee(e,t){if(e&&t){var n=e.getMaxResolution();if(n&&n<=t)return;e.setMaxResolution(t)}}function te(e,r){$.ajax({url:e.url,async:!1}).done(function(e){!function(e){e="object"==typeof e?e:JSON.parse(e);for(var t=new ol.format.GeoJSON,n=0;n<e.features.length;n++){var o=e.features[n];o.type&&r.addFeature(t.readFeature(o))}}(e)})}function ne(e){for(var t=0;t<Y.length;t++){var n=Y[t];if(n.guid===e.id)return n}return null}function oe(e){for(var t=!1,n=0;n<G.length;n++)if(e.id===G[n].id){t=!0;break}t||G.push(e)}function re(e){for(var t,n=0;n<G.length;n++)if(G[n].id===e.guid){t=G[n];break}return t}var ae=function(e){if(void 0!==e){for(var t,n=0;n<v.length;n++)if(v[n]===e){t=S[n];break}return t}},ie=function(e){if(void 0===e&&(e=we()),1===e)return v[v.length-1];if(e!==1/0){for(var t=-1,n=0;n<S.length;n++)if(S[n]<e){t=n-1;break}return t<0?v[v.length-1]:v[t]}};function se(){return g.getLayers().getArray().filter(function(e){return void 0!==e.guid})}function le(e){for(var t=se(),n=0;n<t.length;n++){var o=t[n];if(o.guid===e)return o}return null}function ue(e){for(var t=se(),n=0;n<t.length;n++){if(t[n].guid===e.id)return n}return null}function ce(){var r,e=g.getLayers().getArray();r="sortingIndex",e.sort(function(e,t){var n=e[r],o=t[r];return o<n?-1:n<o?1:0}),de()}function fe(e){for(var t=g.getLayers().getArray(),n=0;n<t.length;n++)if(t[n].guid===e)return t[n]}function de(){var e=he();l.TriggerEvent(ISY.Events.EventTypes.ChangeLayers,e)}function pe(e,t){return e.mapLayerIndex<t.mapLayerIndex?-1:e.mapLayerIndex>t.mapLayerIndex?1:0}var me=function(){r.WindowResized(g)};function ge(){g&&g.updateSize()}function ve(e,t,n){if(void 0!==e&&(void 0===t&&(t=re(e)),void 0!==t)){var o,r;switch(M&&0<M.length&&(o={isyToken:M}),t.source){case ISY.Domain.SubLayer.SOURCES.wmts:r=new ISY.MapImplementation.OL3.Sources.Wmts(t,o),!t.gatekeeper||void 0!==u&&u.IsActive()||z(r);break;case ISY.Domain.SubLayer.SOURCES.proxyWmts:r=new ISY.MapImplementation.OL3.Sources.Wmts(t,o);break;case ISY.Domain.SubLayer.SOURCES.wms:r=new ISY.MapImplementation.OL3.Sources.Wms(t,o),!t.gatekeeper||!t.tiled||void 0!==u&&u.IsActive()||z(r);break;case ISY.Domain.SubLayer.SOURCES.proxyWms:r=new ISY.MapImplementation.OL3.Sources.Wms(t,o);break;case ISY.Domain.SubLayer.SOURCES.vector:r=new ISY.MapImplementation.OL3.Sources.Vector(t),""!==t.url&&te(t,r);break;case ISY.Domain.SubLayer.SOURCES.wfs:o._olSalt=Math.random(),r=new ISY.MapImplementation.OL3.Sources.Wfs(t,u,o,n,l)}r&&e.setSource(r)}}function Se(e,t,n,o,r){return Array.prototype.slice.call(o.getElementsByTagName(e),0).where(function(e){return r?e.getAttribute(t).toLowerCase()===n.toLowerCase():-1<e.getAttribute(t).indexOf(n)||-1<n.indexOf(e.getAttribute(t))})}function ye(e,t,n){u&&u.GetConfigResource(e,t,n)}Array.prototype.where=function(e){for(var t=[],n=0;n<this.length;n++)e(this[n])&&t.push(this[n]);return t};var he=function(){if(void 0!==g){var e={layers:function(){for(var e=[],t=se(),n=0;n<t.length;n++)!0===t[n].getVisible()&&e.push(t[n]);e.sort(pe);for(var o=[],r=0;r<e.length;r++)o.push(e[r].guid);return o.join(",")}()},t=g.getView(),n=t.getCenter(),o=t.getZoom();return o&&(e.zoom=o.toString()),n&&(e.lat=n[1].toFixed(2),e.lon=n[0].toFixed(2)),e}},Ie=function(){return g.getView().getProjection().getCode()};var we=function(){return S[g.getView().getZoom()]},Le=function(e){return void 0!==O[e.guid]?O[e.guid].GetStyleForLegend():void 0};function Me(){var e=g.getView(),t=w.getPosition();if(void 0!==t){e.setCenter(t),function(e,t){var n=le(99999);if(null!==n){var o=n.getSource();o.clear();var r=new ol.style.Style({image:new ol.style.Circle({radius:6,stroke:new ol.style.Stroke({color:"rgba(255,255,255,0.8)",width:2}),fill:new ol.style.Fill({color:"rgba(32,170,172,0.8)"})}),fill:new ol.style.Fill({color:"rgba(0,102,204,0.15)"}),zIndex:1/0}),a=new ol.Feature({geometry:new ol.geom.GeometryCollection([new ol.geom.Point(e),new ol.geom.Circle(e,parseInt(t,10))]),name:"geolocation_center"});if(a.setStyle(r),o.addFeature(a),P){P=!1;var i=a.getGeometry().getExtent();i[0]-=5*t,i[1]-=5*t,i[2]+=5*t,i[3]+=5*t,g.getView().fit(i,g.getSize())}}}(t,w.getAccuracy());var n={center:t,accuracy:Math.round(10*w.getAccuracy())/10,altitude:w.getAltitude(),altitudeAccuracy:w.getAltitudeAccuracy(),heading:w.getHeading(),speed:w.getSpeed()};l.TriggerEvent(ISY.Events.EventTypes.GeolocationUpdated,n)}}return{InitMap:function(e,t){F=t.proxyHost,A=t.tokenHost,D=t.ticketHost,y=t.hoverOptions;var n=t.numZoomLevels,o=[];o[0]=t.newMaxRes,(S=[])[0]=t.newMaxScale;for(var r=1;r<n;r++)o[r]=o[r-1]/2,S[r]=S[r-1]/2;v=o;var a,i=new ol.proj.Projection({code:t.coordinate_system,extent:t.extent,units:t.extentUnits}),s=ol.interaction.defaults({altShiftDragRotate:!1,pinchRotate:!1});g=new ol.Map({target:e,renderer:t.renderer,layers:[],loadTilesWhileAnimating:!0,loadTilesWhileInteracting:!0,view:new ol.View({projection:i,enableRotation:!1,center:t.center,zoom:t.zoom,resolutions:o,maxResolution:t.newMaxRes,numZoomLevels:n}),controls:[],overlays:[],interactions:s}),(a=g.getView()).on("change:center",function(){var e=he();l.TriggerEvent(ISY.Events.EventTypes.ChangeCenter,e)}),a.on("change:resolution",function(){var e=he();l.TriggerEvent(ISY.Events.EventTypes.ChangeResolution,e)}),g.on("moveend",function(){B(),W();var e=he();l.TriggerEvent(ISY.Events.EventTypes.MapMoveend,e)}),t.showProgressBar&&new ISY.MapImplementation.OL3.ProgressBar(l).Init(g),t.showMousePosition&&function(o){var e=document.getElementById("mouseposition");if(e){var r=g.getView().getProjection().getUnits(),a=Ie();void 0===o&&(o="");var t=new ol.control.MousePosition({coordinateFormat:function(e){var t=""+o,n=!1;if(0<t.length)switch(r){case"degrees":n=!(t="");break;case"m":switch(a){case"EPSG:25831":case"EPSG:32631":t+="31 ";break;case"EPSG:25832":case"EPSG:32632":t+="32 ";break;case"EPSG:25833":case"EPSG:32633":t+="33 ";break;case"EPSG:25834":case"EPSG:32634":t+="34 ";break;case"EPSG:25835":case"EPSG:32635":t+="35 ";break;case"EPSG:25836":case"EPSG:32636":t+="36 ";break;case"EPSG:25837":case"EPSG:32637":t+="37 ";break;case"EPSG:25838":case"EPSG:32638":t+="38 "}}return t+=n?Math.round(1e4*e[1])/1e4+L.north+Math.round(1e4*e[0])/1e4+L.east:parseInt(e[1],10)+L.north+parseInt(e[0],10)+L.east},projection:a,className:"mousePosition",target:e});g.addControl(t)}}(t.mouseProjectionPrefix),new ISY.MapImplementation.OL3.Sources.CustomMessageHandler(l,re).Init(g),(E=new ISY.MapImplementation.OL3.Sources.CustomMessageHandler).InitMessage(""),ISY.MapImplementation.OL3.olMap=g},ChangeView:function(e){if(void 0!==g){var t,n,o,r=g.getView();if(e.lon&&(t=e.lon),e.lat&&(n=e.lat),e.zoom&&(o=e.zoom),void 0!==t&&void 0!==n){var a="number"==typeof n?n:parseFloat(n.replace(/,/g,".")),i="number"==typeof t?t:parseFloat(t.replace(/,/g,"."));isFinite(a)&&isFinite(i)&&r.setCenter([i,a])}void 0!==o&&r.setZoom(o)}},ReInitMap:function(e){var t=g.getLayers().getArray();for(r=0;r<t.length;r++)g.removeLayer(t[r]);var n=g.getOverlays();for(j=0;j<n.length;j++)g.removeOverlay(n[j]);for(var o=se(),r=0;r<o.length;r++)!0===o[r].getVisible()&&g.removeLayer(o[r]);Y=[],G=[];var a=e.numZoomLevels,i=[];i[0]=e.newMaxRes,(S=[])[0]=e.newMaxScale;for(var s=1;s<a;s++)i[s]=i[s-1]/2,S[s]=S[s-1]/2;v=i;var l=new ol.proj.Projection({code:e.coordinate_system,extent:e.extent,units:e.extentUnits}),u=new ol.View({projection:l,enableRotation:!1,center:e.center,zoom:e.zoom,resolutions:i,maxResolution:e.newMaxRes,numZoomLevels:a});g.setView(u),ISY.MapImplementation.OL3.olMap=g},AddDataToLayer:function(e,t){var n=ne(e);if(e.format===ISY.Domain.SubLayer.FORMATS.geoJson){var o=JSON.parse(t),r=(new ol.format.GeoJSON).readFeatures(o);if(e.id&&e.name)for(var a=0;a<r.length;++a)void 0===r[a].getProperties().Guid&&r[a].setProperties({Guid:(new ISY.Utils.Guid).NewGuid()}),r[a].setId(e.name+"."+r[a].getProperties().Guid);n.getSource().addFeatures(r)}},RemoveDataFromLayer:function(e,t){var n=ne(e);if(e.format===ISY.Domain.SubLayer.FORMATS.geoJson)for(var o=JSON.parse(t),r=(new ol.format.GeoJSON).readFeatures(o),a=0;a<r.length;++a)if(r[a].getProperties().Guid){var i=n.getSource().getFeatureById(e.name+"."+r[a].getProperties().Guid);i&&n.getSource().removeFeature(i)}},ClearLayer:function(e){var t=ne(e);void 0!==t&&t.getSource().clear()},ShowLayer:function(e){if(!J(e)){var t=q(e);t&&(t.sortingIndex=e.sortingIndex,g.addLayer(t),de())}},ShowBaseLayer:function(e){if(!J(e)){var t=q(e);t&&(g.getLayers().insertAt(0,t),de())}},HideLayer:function(e){if(J(e)){var t=le(e.id);t&&(g.removeLayer(t),de())}},GetLayerByName:function(e){for(var t=se(),n=0;n<t.length;n++)if(t[n].get("title")===e)return t[n];return null},SetLayerOpacity:function(e,t){var n=le(e.id);n&&!isNaN(t)&&n.setOpacity(Math.min(t,1))},SetLayerSaturation:function(e,t){var n=le(e.id);n&&!isNaN(t)&&n.setSaturation(Math.min(t,1))},SetLayerHue:function(e,t){var n=le(e.id);n&&!isNaN(t)&&n.setHue(Math.min(t,1))},SetLayerBrightness:function(e,t){var n=le(e.id);n&&!isNaN(t)&&n.setBrightness(Math.min(t,1))},SetLayerContrast:function(e,t){var n=le(e.id);n&&!isNaN(t)&&n.setContrast(Math.min(t,1))},MoveLayerToIndex:function(e,t){for(var n=ue(e),o=g.getLayers().getArray(),r=0;r<o.length;r++)if(void 0===o[r].guid){o.splice(r,1);break}o.splice(t,0,o.splice(n,1)[0]),de()},GetLayerIndex:ue,GetLegendStyles:function(e){var t=ne(e);if(null!==t)return Le(t)},RefreshLayer:ve,RefreshIsyLayer:function(e,t){ve(ne(e),e,t)},RedrawMap:ge,RefreshMap:function(){g.getLayers().forEach(function(e){ve(e)})},RefreshLayerByGuid:function(e,t){e&&ve(function(e){for(var t=0;t<Y.length;t++){var n=Y[t];if(n.guid===e)return n}return null}(e),void 0,t)},RenderSync:function(){g.renderSync()},ExportMap:function(e){r.ExportMap(e,g)},ActivateExport:function(e){r.Activate(e,g,ge),window.addEventListener("resize",me,!1)},DeactivateExport:function(){window.removeEventListener("resize",me,!1),r.Deactivate(ge)},ActivateInfoClick:function(e){o.ActivateInfoClick(e,g)},DeactivateInfoClick:function(){o.DeactivateInfoClick(g)},GetInfoUrl:function(e,t){return F+o.GetFeatureInfoUrl(e,ne(e),t,g.getView())},ShowHighlightedFeatures:function(e,t){o.ShowHighlightedFeatures(function(e,t){if(void 0===e)return t;for(var n,o=ae(g.getView().getResolution()),r=function(e){for(var t=0;t<n.attributes.length;t++)if(e===n.attributes[t][0])return n.attributes[t][1]},a=0;a<t.length;a++){n=t[a],void 0===t[a].get&&(t[a].get=r);var i=O[e].GetHoverStyle(t[a],o);i&&(t[a].hoverstyle=i)}return t}(e,t),g)},ClearHighlightedFeatures:function(){o.ClearHighlightedFeatures()},ShowInfoMarker:function(e,t){o.ShowInfoMarker(e,t,g)},ShowInfoMarkers:function(e,t){o.ShowInfoMarkers(e,t,g)},SetHighlightStyle:function(e){o.SetHighlightStyle(e)},RemoveInfoMarker:function(e){o.RemoveInfoMarker(e,g)},RemoveInfoMarkers:function(e){o.RemoveInfoMarkers(e,g)},ActivateBoxSelect:function(e){o.ActivateBoxSelect(e,g)},DeactivateBoxSelect:function(){o.DeactivateBoxSelect(g)},GetFeaturesInExtent:function(e,t){return o.GetFeaturesInExtent(t,ne(e),g.getView().getResolution())},GetExtentForCoordinate:function(e,t){return o.GetExtentForCoordinate(e,t,g.getView().getResolution())},GetFeatureCollection:function(e){return o.GetFeatureCollection(ne(e))},GetFeatureExtent:function(e){return o.GetFeatureExtent(e)},GetFeaturesInMap:function(e){return o.GetFeaturesInMap(ne(e))},GetLayerByFeature:function(e){return function(e){var t=e.get("layerguid");if(void 0===t){if(void 0===(t=e.getId()))return null;if(0<t.indexOf("."))t=t.slice(0,t.indexOf("."));else{var n=t.substr(0,t.indexOf("_"))+":"+t.substr(t.indexOf("_")+1);t=n.slice(0,n.indexOf("_"))}for(var o=0;o<Y.length;o++){var r=Y[o],a=r.typename;if(0<a.indexOf(":")&&(a=a.slice(a.indexOf(":")+1)),a===t)return r}}else for(var i=0;i<Y.length;i++)if(t===Y[i].guid)return Y[i];return null}(e)},GetHoverStyle:function(e,t){var n=this.GetLayerByFeature(e);if(n)return O[n.guid]?O[n.guid].GetHoverStyle(e,ae(t)):n.getStyle?n.getStyle():void 0},GetLegendStyleFromLayer:Le,InitEdit:function e(t){if(""===t.featureNS||void 0===t.featureNS)return!1;var n=ne(t);if(null!==n)return T.Init(t.url,t.name,t.featureNS,t.coordinate_system,n.getSource(),t.geometryName),!0;q(t),e(t)},ActivateEditSelect:function(e){T.ActivateEditSelect(e,g)},DeactivateEditSelect:function(){T.DeactivateEditSelect(g)},HandlePointSelect:function(e){T.HandlePointSelect(e)},UpdateFeature:function(e){T.UpdateFeature(e)},InsertFeature:function(e,t){return T.InsertFeature(e,t)},DeleteFeature:function(e){return T.DeleteFeature(e)},ActivateHoverInfo:function(e){a.ActivateHoverInfo(g,e,this,y)},DeactivateHoverInfo:function(){a.DeactivateHoverInfo(g)},ActivateMeasure:function(e,t){n.Activate(g,e,t)},DeactivateMeasure:function(){n.Deactivate(g)},ActivateMeasureLine:function(e,t){i.Activate(g,e,t)},DeactivateMeasureLine:function(){i.Deactivate(g)},ActivateAddLayerFeature:function(e){c.Activate(g,e)},DeactivateAddLayerFeature:function(){c.Deactivate(g)},ActivateAddFeatureGps:function(e){d.Activate(g,e)},AddCoordinatesGps:function(e){d.AddCoordinates(e)},DeactivateAddFeatureGps:function(){d.Deactivate(g)},ActivateModifyFeature:function(e){f.Activate(g,e)},DeactivateModifyFeature:function(){f.Deactivate(g)},ActivateDrawFeature:function(e,t){s.Activate(g,e,t)},DeactivateDrawFeature:function(){s.Deactivate(g)},ActivateOffline:function(){u&&u.Activate()},StartCaching:function(e,t,n){u&&u.StartCaching(e,t,n,l)},StopCaching:function(){u.StopCaching()},DeleteDatabase:function(e,t,n){u.DeleteDatabase(e,t,n)},CacheDatabaseExist:function(){return u.CacheDatabaseExist()},CalculateTileCount:function(e,t,n){if(u)return u.CalculateTileCount(e,t,n)},GetResource:function(e,t,n){u&&u.GetResource(e,t,n)},GetConfigResource:ye,GetLayerResource:function(e,t,n){u&&u.GetLayerResource(e,t,n)},DeactivateOffline:function(){u&&u.Deactivate()},GetResourceFromJson:function(e,t,n){u&&u.GetResourceFromJson(e,t,n)},ActivatePrintBoxSelect:function(e){p.Activate(g,e)},DeactivatePrintBoxSelect:function(){p.Deactivate(g)},ActivateAddLayerUrl:function(e){m.Activate(g,e)},DeactivateAddLayerUrl:function(){m.Deactivate(g)},TransformBox:function(e,t,n){var o=n;if(""!==e&&""!==t&&e!==t){var r=ol.proj.transformExtent(n,e,t);o=r,"EPSG:4326"===t&&(o=r[1]+","+r[0]+","+r[3]+","+r[2])}return o},ConvertGmlToGeoJson:function(e){var t=(new ol.format.WMSCapabilities).read(e),n=(new ol.format.GML).readFeatures(t);return(new ol.format.GeoJSON).writeFeatures(n)},ExtentToGeoJson:function(e,t){var n=new ol.geom.Point([e,t]),o=new ol.Feature;return o.setGeometry(n),(new ol.format.GeoJSON).writeFeature(o)},AddZoom:function(){var e=new ol.control.Zoom;g.addControl(e)},AddZoomSlider:function(){var e=new ol.control.ZoomSlider;g.addControl(e)},AddZoomToExtent:function(e){var t=new ol.control.ZoomToExtent({extent:e});g.addControl(t)},AddScaleLine:function(){var e=new ol.control.ScaleLine;g.addControl(e)},ZoomToLayer:function(e){var t,n=ne(e);n&&(t=void 0!==n.getSource().getExtent?n.getSource().getExtent():n.getSource().getTileGrid().getExtent(),Array.isArray(t)&&t[0]!==1/0&&(ol.extent.containsCoordinate(t,g.getView().getCenter())||g.getView().fit(t,g.getSize())))},ZoomToLayers:function(e){var r=[1/0,1/0,-1/0,-1/0];e.forEach(function(e){var t,n=ne(e);if(n){var o=n.getSource().getExtent();Array.isArray(o)&&o[0]!==1/0&&(t=o,r[0]>t[0]&&(r[0]=t[0]),r[1]>t[1]&&(r[1]=t[1]),r[2]<t[2]&&(r[2]=t[2]),r[3]<t[3]&&(r[3]=t[3]))}}),Array.isArray(r)&&r[0]!==1/0&&g.getView().fit(r,g.getSize())},FitExtent:function(e){g.getView().fit(e,g.getSize())},GetCenter:function(){var e=g.getView(),t=e.getCenter(),n=e.getZoom();return{lon:t[0],lat:t[1],zoom:n}},SetCenter:function(e){var t=g.getView();e.epsg&&(e=function(e,t){if(""!==e.epsg&&""!==t&&e.epsg!==t){var n=ol.proj.transform([e.lon,e.lat],e.epsg,t);"EPSG:4326"===t&&(n=[n[1],n[0]]),e.lon=n[0],e.lat=n[1],e.epsg=t}return e}(e,Ie())),t.setCenter([e.lon,e.lat]),e.zoom&&t.setZoom(e.zoom)},GetZoom:function(){return g.getView().getZoom()},SetZoom:function(e){return g.getView().setZoom(e)},GetRotation:function(){return g.getView().getRotation()},SetRotation:function(e,t){var n=g.getView();t?n.rotate(e,t):n.setRotation(e)},GetEpsgCode:Ie,GetVectorLayers:function(e,t){for(var n=[],o=ISY.MapImplementation.OL3.Sources.Vector(e.subLayers[0],g.getView().getProjection()),r=ol.proj.get(e.subLayers[0].coordinate_system),a=ol.proj.get(o.getProjection().getCode()),i=o.parser.readFeatures(t),s=0;s<i.length;s++){var l=i[s];l.getGeometry().transform(r,a),n.push(l)}return n},GetLayerCount:function(){return g?g.getLayers().getArray().length:0},GetCenterFromExtent:function(e){return ol.extent.getCenter(e)},GetScale:we,SortLayerBySortIndex:ce,UpdateLayerSortIndex:function(e){for(var t=0;t<e.length&&void 0!==e[t].isyLayers;t++)for(var n=0;n<e[t].isyLayers.length;n++)for(var o=0;o<e[t].isyLayers[n].subLayers.length;o++){var r=fe(e[t].isyLayers[n].subLayers[o].id);void 0!==r&&(r.sortingIndex=e[t].isyLayers[n].subLayers[o].sortingIndex)}},GetExtent:function(){return g.getView().calculateExtent(g.getSize())},GetUrlObject:function(){return he()},GetGeolocation:function(){var e,t,n=g.getView().getProjection();w=new ol.Geolocation({projection:n,tracking:!0,trackingOptions:{maximumAge:0}}),e=99999,(t=new ol.layer.Vector({source:new ol.source.Vector,projection:g.getView().getProjection()})).guid=e,g.addLayer(t),de(),P=!0,w.on("change:position",Me),w.on("change:accuracy",Me)},RemoveGeolocation:function(){var e=le(99999);null!==e&&(g.removeLayer(e),de()),void 0!==w&&(w.un("change:position",Me),w.un("change:accuracy",Me),w=void 0)},GetProxyHost:function(){return F},SetTranslateOptions:function(e){L=e},TransformCoordinates:function(e,t,n){if(proj4.defs(e)&&proj4.defs(t))return proj4(e,t).forward(n)},TransformFromGeographic:function(e){var t=Ie();if(proj4.defs(t))return proj4(t).forward(e)},TransformToGeographic:function(e){var t=Ie();if(proj4.defs(t))return proj4(t).inverse(e)},DescribeFeature:function(e,t){C=e,x=t;var n=ol.proj.get(e.coordinate_system);(b=new ol.source.Vector({projection:n})).set("type","ol.source.Vector");var o=e.url;Array.isArray(e.url)&&(o=e.url[0]),o.toLowerCase().indexOf("service=wfs")<0&&(o+="service=WFS&"),o+="request=DescribeFeatureType&version="+e.version+"&typename="+e.name,$.ajax({url:o}).done(function(e){!function(e){var t=C.name.split(":");if(0<t.length){var n=Se("element","name",t=t[t.length-1],e,!0)[0],o=Se("element","type",x,n,!1)[0];if(void 0!==o){o=o.getAttribute("name");var r=e.firstChild.getAttribute("targetNamespace");if(void 0===b.format){var a;switch(C.version){case"1.0.0":a=new ol.format.GML2;break;case"1.1.0":case"2.0.0":a=new ol.format.GML3;break;default:a=new ol.format.GML}b.format=new ol.format.WFS({featureType:C.providerName,featureNS:r,gmlFormat:a})}C.featureNS=r,C.geometryName=o,l.TriggerEvent(ISY.Events.EventTypes.FeatureHasBeenDescribed,[C,b])}}}(e)})},RemoveIsyToken:function(){M=void 0;for(var e={isyToken:""},t=0;t<G.length;t++){G[t].isyToken=M;var n,o=G[t],r=ne(o),a=!1;switch(o.source){case ISY.Domain.SubLayer.SOURCES.wms:case ISY.Domain.SubLayer.SOURCES.wmts:case ISY.Domain.SubLayer.SOURCES.proxyWms:case ISY.Domain.SubLayer.SOURCES.proxyWmts:n=r.getSource();break;case ISY.Domain.SubLayer.SOURCES.vector:a=!0,n=new ISY.MapImplementation.OL3.Sources.Vector(o),""!==o.url&&te(o,n);break;case ISY.Domain.SubLayer.SOURCES.wfs:a=!0,n=new ISY.MapImplementation.OL3.Sources.Wfs(o,u)}n&&(a?r.setSource(n):n.updateParams(e))}},SetIsyToken:function(e){if(0!==e.length&&(!M||M!==e))for(var t={isyToken:M=e},n=0;n<G.length;n++){G[n].isyToken=M;var o,r=G[n],a=ne(r),i=!1;switch(r.source){case ISY.Domain.SubLayer.SOURCES.wms:case ISY.Domain.SubLayer.SOURCES.wmts:case ISY.Domain.SubLayer.SOURCES.proxyWms:case ISY.Domain.SubLayer.SOURCES.proxyWmts:o=a.getSource();break;case ISY.Domain.SubLayer.SOURCES.vector:i=!0,o=new ISY.MapImplementation.OL3.Sources.Vector(r),""!==r.url&&te(r,o);break;case ISY.Domain.SubLayer.SOURCES.wfs:i=!0,o=new ISY.MapImplementation.OL3.Sources.Wfs(r,u,t)}o&&(i?a.setSource(o):o.updateParams(t))}},ShowCustomMessage:function(e){E.ShowCustomMessage(e)}}},ISY.MapImplementation.OL3.Map.RENDERERS={canvas:"canvas",webgl:"webgl"},(ISY=ISY||{}).MapImplementation=ISY.MapImplementation||{},ISY.MapImplementation.OL3=ISY.MapImplementation.OL3||{},ISY.MapImplementation.OL3.Measure=function(l){var u,c,r,o,a,i,s,f,d,p,m,g=!1,n=function(e){if(!e.dragging&&g){var t=o.start_measure;if(a){var n=a.getGeometry();n instanceof ol.geom.Polygon?t=o.continue_measure:n instanceof ol.geom.LineString&&(t="Click to continue drawing the line")}i.innerHTML=t,s.setPosition(e.coordinate),$(i).removeClass("hidden")}};function v(e){r=new ol.layer.Vector({map:e,source:new ol.source.Vector({useSpatialIndex:!1}),updateWhileAnimating:!0,updateWhileInteracting:!0});var t=new ol.source.Vector;p=new ol.interaction.Draw({source:t,type:"Polygon"});var n,o=new ISY.MapImplementation.OL3.Styles.Measure;m=new ol.layer.Vector({source:t,style:o.Styles()}),e.addInteraction(p),e.addLayer(m),S(e),function(e){i&&null!==i.parentNode&&i.parentNode.removeChild(i);(i=document.createElement("div")).className="tooltip hidden",s=new ol.Overlay({element:i,offset:[15,0],positioning:"center-left"}),e.addOverlay(s)}(e),p.on("drawstart",function(e){var t=(a=e.feature).getGeometry().getCoordinates()[0][0];u=new ol.Feature(new ol.geom.Circle(t,0)),r.getSource().addFeature(u);var s=e.coordinate;n=a.getGeometry().on("change",function(e){var t,n,o,r,a=e.target;if(a instanceof ol.geom.Polygon){t=h(a),s=a.getInteriorPoint().getCoordinates(),o=a.getCoordinates()[0],r=function(e){var t;if(0<e.length){var n=e[0].length,o=function(e){for(var t=[],n=0;n<e.length;n++)for(var o=e[n],r=0;r<o.length;r++)t.push(o[r]);return t}(e);t=function(e,t,n,o){var r,a=e[t],i=e[t+1],s=0;for(r=t+o;r<n;r+=o){var l=e[r],u=e[r+1];s+=Math.sqrt((l-a)*(l-a)+(u-i)*(u-i)),a=l,i=u}return s}(o,0,o.length,n)}return t}(o),c=r,100<(r=Math.round(100*r)/100)?("km",Math.round(r/1e3*100)/100):("m",Math.round(100*r)/100);var i=2===a.getCoordinates()[0].length?(u.getGeometry().setRadius(c),Math.PI*Math.pow(c,2)):(u.getGeometry().setRadius(0),null);null!==i&&(n=h(i))}else a instanceof ol.geom.LineString&&(t=y(a),s=a.getLastCoordinate());2===a.getCoordinates()[0].length?f.innerHTML=n.string:f.innerHTML=t.string,l.TriggerEvent(ISY.Events.EventTypes.MeasureMouseMove,t),d.setPosition(s)})},this),p.on("drawend",function(){f.className="tooltip tooltip-static",d.setOffset([0,-7]),f=a=null,S(e),ol.Observable.unByKey(n)},this)}function S(e){f&&null!==f.parentNode&&f.parentNode.removeChild(f),(f=document.createElement("div")).className="tooltip tooltip-measure",d=new ol.Overlay({element:f,offset:[0,-15],positioning:"bottom-center"}),e.addOverlay(d)}var y=function(e){var t=Math.round(100*e.getLength())/100;return 100<t?Math.round(t/1e3*100)/100+" km":Math.round(100*t)/100+" m"};var h=function(e){var t,n,o;return{string:1e5<(o=void 0===e.getArea?e:e.getArea())?(t="km<sup>2</sup>",(n=Math.round(o/1e6*100)/100)+" "+t):o<1e5&&1e3<o?(t="da",(n=Math.round(o/1e3*100)/100)+" "+t):(t="m<sup>2</sup>",(n=Math.round(100*o)/100)+" "+t),unit:t,value:n,order:2}};return{Activate:function(e,t){g=!0,o=t.translate,e.on("pointermove",n),$(e.getViewport()).on("mouseout",function(){$(i).addClass("hidden")}),v(e)},Deactivate:function(e){if(g){if(g=!1,void 0!==e){e.removeLayer(m),f.className="tooltip tooltip-static",d.setOffset([0,-7]),u.getGeometry().setRadius(0),f=null,e.removeInteraction(p),e.removeOverlay(r),e.removeOverlay(d),e.removeOverlay(s),i&&i.parentNode.removeChild(i),f&&f.parentNode.removeChild(f);for(var t=document.getElementsByClassName("tooltip tooltip-static");0<t.length;){var n=t[0];n.parentNode.removeChild(n)}}l.TriggerEvent(ISY.Events.EventTypes.MeasureEnd)}}}},(ISY=ISY||{}).MapImplementation=ISY.MapImplementation||{},ISY.MapImplementation.OL3=ISY.MapImplementation.OL3||{},ISY.MapImplementation.OL3.MeasureLine=function(r){var o,a,i,s,l,u,c,f,d=!1,n=function(e){if(!e.dragging&&d){var t=o.start_measure_line;if(a){var n=a.getGeometry();n instanceof ol.geom.Polygon?t="Click to continue drawing the polygon":n instanceof ol.geom.LineString&&(t=o.continue_measure_line)}i.innerHTML=t,s.setPosition(e.coordinate),$(i).removeClass("hidden")}};function p(e){var t=new ol.source.Vector;c=new ol.interaction.Draw({source:t,type:"LineString"});var n,o=new ISY.MapImplementation.OL3.Styles.Measure;f=new ol.layer.Vector({source:t,style:o.Styles()}),e.addInteraction(c),e.addLayer(f),m(e),function(e){i&&null!==i.parentNode&&i.parentNode.removeChild(i);(i=document.createElement("div")).className="tooltip hidden",s=new ol.Overlay({element:i,offset:[15,0],positioning:"center-left"}),e.addOverlay(s)}(e),c.on("drawstart",function(e){a=e.feature;var o=e.coordinate;n=a.getGeometry().on("change",function(e){var t,n=e.target;n instanceof ol.geom.Polygon?(t=v(n),o=n.getInteriorPoint().getCoordinates()):n instanceof ol.geom.LineString&&(t=g(n),o=n.getLastCoordinate()),l.innerHTML=t.string,r.TriggerEvent(ISY.Events.EventTypes.MeasureMouseMove,t),u.setPosition(o)})},this),c.on("drawend",function(){l.className="tooltip tooltip-static",u.setOffset([0,-7]),l=a=null,m(e),ol.Observable.unByKey(n)},this)}function m(e){l&&null!==l.parentNode&&l.parentNode.removeChild(l),(l=document.createElement("div")).className="tooltip tooltip-measure",u=new ol.Overlay({element:l,offset:[0,-15],positioning:"bottom-center"}),e.addOverlay(u)}var g=function(e){var t,n,o=Math.round(100*e.getLength())/100;return{string:1e3<o?(t="km",(n=Math.round(o/1e3*100)/100)+" "+t):(t="m",(n=Math.round(100*o)/100)+" "+t),unit:t,value:n,order:1}},v=function(e){var t=e.getArea();return 1e4<t?Math.round(t/1e6*100)/100+" km<sup>2</sup>":Math.round(100*t)/100+" m<sup>2</sup>"};return{Activate:function(e,t){d=!0,o=t.translate,e.on("pointermove",n),$(e.getViewport()).on("mouseout",function(){$(i).addClass("hidden")}),p(e)},Deactivate:function(e){if(d){if(d=!1,void 0!==e){e.removeLayer(f),l.className="tooltip tooltip-static",u.setOffset([0,-7]),l=null,e.removeInteraction(c),e.removeOverlay(u),e.removeOverlay(s),i&&i.parentNode.removeChild(i),l&&l.parentNode.removeChild(l);for(var t=document.getElementsByClassName("tooltip tooltip-static");0<t.length;){var n=t[0];n.parentNode.removeChild(n)}}r.TriggerEvent(ISY.Events.EventTypes.MeasureEnd)}}}},(ISY=ISY||{}).MapImplementation=ISY.MapImplementation||{},ISY.MapImplementation.OL3=ISY.MapImplementation.OL3||{},ISY.MapImplementation.OL3.ModifyFeature=function(r){var o,a,i,s,l,u,c,f,d,p=!1,m=function(e){if(p){var t=o.start_modify;void 0!==u&&(u.innerHTML=t,c.setPosition(e.coordinate),$(u).removeClass("hidden"))}};function g(e){"Line"===a&&(a="LineString");var t,n,o=new ol.Collection(i);f=new ol.interaction.Modify({features:o,deleteCondition:function(e){return ol.events.condition.shiftKeyOnly(e)&&ol.events.condition.singleClick(e)}}),e.addInteraction(f),t=e,n=new ol.Collection(s),d=new ol.interaction.Snap({features:n}),t.addInteraction(d),function(e){u&&null!==u.parentNode&&u.parentNode.removeChild(u);(u=document.createElement("div")).className="tooltip hidden",c=new ol.Overlay({element:u,offset:[15,0],positioning:"center-left"}),e.addOverlay(c)}(e),f.on("modifyend",function(e){ol.Observable.unByKey(void 0),l=e.features.getArray()[0],r.TriggerEvent(ISY.Events.EventTypes.ModifyFeatureEnd,l)},this)}return{Activate:function(e,t){if(p=!0,o=t.translate,i=[],Array.isArray(t.features))for(var n=0;n<t.features.length;n++)i.push(t.features[n]);else i.push(t.features);s=t.snappingFeatures,e.on("pointermove",m),$(e.getViewport()).on("mouseout",function(){$(u).addClass("hidden")}),g(e)},Deactivate:function(e){p&&(p=!1,l=null,void 0!==e&&(e.removeInteraction(f),e.removeInteraction(d),function(e){e.removeOverlay(c),null!==u&&null!==u.parentNode&&u.parentNode.removeChild(u);for(var t=document.getElementsByClassName("tooltip tooltip-static");0<t.length;){var n=t[0];n.parentNode.removeChild(n)}}(e)))}}},(ISY=ISY||{}).MapImplementation=ISY.MapImplementation||{},ISY.MapImplementation.OL3=ISY.MapImplementation.OL3||{},ISY.MapImplementation.OL3.Offline=function(){var d,p,m,a,g,v,i,u,S,y,n,l=!1,c="config",h="map",I={},s="pouchtiles:",r=0,f=!0,w=!0,L=[],M=[],C=0,b=[],x=0,E=[],t=function(){return l},Y=function(){l||(l=!0,a=S.getCenter(),E.length=0,i=new ol.layer.Vector({source:new ol.source.Vector({features:E})}),u.addLayer(i),O(h),e())},e=function(){r=0;for(var e=u.getLayers().getArray(),t=0;t<e.length;t++){console.log("checking "+e[t].typename+" for offline activation");var n=e[t].get("config");if(n)if("wms"===n.source.toLowerCase()||"proxywms"===n.source.toLowerCase())T(e[t]),console.log("wms "+e[t].typename+" activated offline");else if("wfs"===n.source.toLowerCase()){var o=e[t].getSource();o&&(o.clear(),o.set("caching",!0),console.log("wfs "+e[t].typename+" activated offline"))}}},G=function(){void 0!==u&&void 0!==i&&(E.length=0,i.getSource().clear(),u.removeLayer(i)),l&&(l=!1,o())},o=function(){for(var e=u.getLayers().getArray(),t=0;t<e.length;t++){var n=e[t].get("config");if(n)if("wms"===n.source.toLowerCase()||"proxywms"===n.source.toLowerCase())P(e[t]);else if("wfs"===n.source.toLowerCase()){var o=e[t].getSource();o&&o.set("caching",!1)}}},O=function(e){return I[e]||(I[e]=new PouchDB(s+e)),I[e]},T=function(e){var t=e.getSource();_(t,H),t.on("tileloadstart",function(){++r,f=!1}),t.on("tileloadend",function(){V()}),t.on("tileloaderror",function(){V()})},P=function(e){var t=e.getSource();_(t,void 0),t.un("tileloadstart",function(){}),t.un("tileloadend",function(){}),t.un("tileloaderror",function(){})},F=function(e){return n=!1,I[c]&&I[c].get(e).then(function(e){e.hasOwnProperty("title")&&"cacheCreated"===e.title&&(n=e.isCacheCreated,y.TriggerEvent(ISY.Events.EventTypes.StatusPouchDbChanged,n))}),n},A=function(t){I[c]&&I[c].get("settings").then(function(e){return n=t,y.TriggerEvent(ISY.Events.EventTypes.StatusPouchDbChanged,n),I[c].put({_id:"settings",_rev:e._rev,title:"cacheCreated",isCacheCreated:t})}).then(function(e){Q(e)}).catch(function(e){e&&"not_found"===e.name?(n=t,y.TriggerEvent(ISY.Events.EventTypes.StatusPouchDbChanged,n),I[c].put({_id:"settings",title:"cacheCreated",isCacheCreated:t}).then(function(e){console.log(e)}).catch(function(e){console.log(e)})):Q(e)})},D=function(e,t,n){var o=t?c:h;O(o),I[o].getAttachment(e,"resource").then(function(e){blobUtil.blobToBinaryString(e).then(function(e){resource=JSON.parse(e),n(resource,!0)}).catch(function(e){console.log("_getOfflineResource ny feil: "+e),n(void 0,!1)})}).catch(function(e){console.log(e),n(void 0,!1)})},k=function(e,t,n,o){R(e,t,n,o)},R=function(u,c,f,d){var p=h;O(p),I.map.get(u).then(function(l){I.map.getAttachment(u,c,function(e,t){var n,o,r,a,i,s;e&&"not_found"===e.error||!t?(n=u,o=c,r=f,a=p,i=l._rev,s=d,navigator.onLine&&$.ajax({url:r}).done(function(e){if("object"==typeof e&&0!==e.firstChild.childElementCount){s&&s(e);var t=new XMLSerializer;O(a),I[a].putAttachment(n,o,i,btoa(t.serializeToString(e)),"text/plain").then(function(){console.log(n+" added wfs "+o+" to cache!")}).catch(function(e){console.log(n+" add wfs "+o+" failed! "+e)})}})):blobUtil.blobToBase64String(t).then(function(e){d&&d($.parseXML(atob(e))),console.log(u+" retrieved "+c+" wfs from cache!")}).catch(function(e){console.log(u+" retrieve "+c+" wfs failed! "+e)})})}).catch(function(e){var n,o,r,a,i;console.log("getLayerResource ny feil: "+e),404===e.status&&(n=u,o=c,r=f,a=p,navigator.onLine&&t()&&$.ajax({url:r}).done(function(e){if("object"==typeof e&&0!==e.firstChild.childElementCount){i&&i(e);var t=new XMLSerializer;O(a),I[a].putAttachment(n,o,btoa(t.serializeToString(e)),"text/plain").then(function(){console.log(n+" added wfs "+o+" to cache!")}).catch(function(e){console.log(n+" add wfs "+o+" failed! "+e),409===e.status&&(console.log("Retry:"+n+" add wfs "+o),k(n,o,r,a))})}}))})},N=function(t,e,n,o){var r,a,i,s=o?c:h;if(O(s),l)D(t,o,n);else{try{$.ajax({type:"GET",url:t,async:!1}).done(function(e){i=!0,r=e,a=btoa(unescape(encodeURIComponent(JSON.stringify(e))))}).fail(function(){i=!1,D(t,o,n)})}catch(e){return i=!1,void D(t,o,n)}i&&(I[s].get(t).then(function(e){I[s].put({_id:t,_rev:e._rev,_attachments:{resource:{content_type:"text/plain",data:a}}}).catch(function(e){console.log("ny feil: "+e)})}).then(function(){}).catch(function(e){e&&"not_found"===e.name?I[s].put({_id:t,_attachments:{resource:{content_type:"text/plain",data:a}}}).catch(function(e){console.log(e)}):Q(e)}),n(r,!1))}},j=function(t,e,n,o){var r,a,i;O(o?c:h);var s=o?c:h;if(l)D(t,o,n);else{try{if(!(r=$.ajax({type:"GET",url:t,async:!1}).responseText))return void D(t,o,n);a="application/json"===e.toLowerCase()?xml.xmlToJSON(r):r,i=btoa(JSON.stringify(a))}catch(e){return D(t,o,n),void n(a,!1)}O(s),I[s].get(t).then(function(e){I[s].put({_id:t,_rev:e._rev,_attachments:{resource:{content_type:"text/plain",data:i}}}).catch(function(e){console.log("ny feil: "+e)})}).then(function(){}).catch(function(e){e&&"not_found"===e.name?I[s].put({_id:t,_attachments:{resource:{content_type:"text/plain",data:i}}}).catch(function(e){console.log(e),n(a,!1)}):Q(e)}),n(a,!1)}},V=function(){--r<=0&&(f=!0,w||U())},U=function(){var e=x;if(b[e]>=L[e]*M[e]){if(e>=b.length-1)return w=!0,G(),S.setZoom(m),S.setCenter(a),u.removeLayer(i),void y.TriggerEvent(ISY.Events.EventTypes.CachingEnd,Z());e=++x}if(y){var t,n;if(y.TriggerEvent(ISY.Events.EventTypes.CachingProgress,Z()),S.getZoom()!==m+e&&S.setZoom(m+e),1===M[e])t=g[0]+(v[0]-g[0])/2,n=v[1]+(g[1]-v[1])/2,S.setCenter([t,n]),b[e]=1/0;else{var o=Math.floor(b[e]/M[e])%(M[e]-(M[e]-L[e])),r=b[e]%M[e];t=g[0]+o*(v[0]-g[0])/(L[e]-1),n=g[1]+r*(v[1]-g[1])/(M[e]-1),S.setCenter([t,n]),K([t,n]),b[e]++}setTimeout(function(){f&&!w&&U()},100)}},_=function(e,t){if(e)if(t){var n=e.getTileLoadFunction();e.setTileLoadFunction(t),e.set("onlineTLF",n)}else{var o=e.get("onlineTLF");"function"==typeof o&&e.setTileLoadFunction(o)}},B=function(n,o,r,a){O(h),I.map.get(n).then(function(t){I.map.getAttachment(n,o).then(function(e){e?(a.getImage().src=window.URL.createObjectURL(e),Q(n+" wms "+o+" retrieved from cache!")):(z(n,o,r,t._rev),a.getImage().src=r)}).catch(function(e){console.log("_wmsAddOrUpdatePouchAttachment - Ny feil: "+e)})}).catch(function(e){404===e.status&&(W(n,o,r,a),a.getImage().src=r)})},W=function(t,n,o,r){O(h),blobUtil.imgSrcToBlob(o,"image/jpeg","Anonymous").then(function(e){I.map.putAttachment(t,n,e,"image/png").then(function(){Q(t+" wms added to cache!")}).catch(function(e){console.log(t+" add wms "+n+" failed! "+e),409===e.status&&(console.log("Retry:"+t+" add wms "+n),B(t,n,o,r))})}).catch(function(e){console.log("ny feil: "+e)})},z=function(t,n,o,r){O(h),blobUtil.imgSrcToBlob(o,"image/jpeg","Anonymous").then(function(e){I.map.putAttachment(t,n,r,e,"image/png").then(function(){Q(t+" wms added to cache!")}).catch(function(e){Q(t+" add wms failed! "+e)})}).catch(function(e){console.log(t+" add wms "+n+" failed! "+e),409===e.status&&(console.log("Retry:"+t+" add wms "+n),z(t,n,o,r))})},H=function(e,t){var n="LAYERS=",o=t.substr(t.search(n,"i")),r=o.substr(n.length,o.indexOf("&")-n.length);r||(r="layer");var a=this.getTileCoord().join("-");B(a,r+".png",t,e)},J=function(e,t,n,o){Y(),y=o;var r=S.getZoom(),a=S.getResolution(),i=r-e;0<i&&(a*=Math.pow(2,i)),C=t-e,S.setZoom(e);var s=n;g=[s[0],s[3]],v=[s[2],s[1]],q(g,v),m=S.getZoom(),A(!(w=!1));var l=(s[2]-s[0])/S.getResolution(),u=(s[3]-s[1])/S.getResolution();d=Math.abs(Math.ceil((v[0]-g[0])/a*Math.pow(2,C)/l)),p=Math.abs(Math.ceil((g[1]-v[1])/a*Math.pow(2,C)/u)),L.length=0,M.length=0;for(var c=b.length=0,f=0;f<C;f++)(b[f]=0)<i?(L[f]=1,M[f]=1,i--):(L[f]=Math.abs(Math.ceil((v[0]-g[0])/a*Math.pow(2,c+1)/l)),M[f]=Math.abs(Math.ceil((g[1]-v[1])/a*Math.pow(2,c+1)/u)),c++);1<d&&1<p?(y.TriggerEvent(ISY.Events.EventTypes.CachingStart,X()),U()):Q("Area too small! Increase area or number of zoom levels!")},Z=function(){var e=0;if(0<b.length&&0<b.length)for(var t=0;t<C;t++)b[t]===1/0?e++:e+=b[t];return e},X=function(){var e=0;if(0<L.length&&0<M.length)for(var t=0;t<C;t++)e+=L[t]*M[t];return e},K=function(e){var t=i.getSource(),n=new ol.Feature({geometry:new ol.geom.Circle(e,5*S.getResolution())});return n.setStyle(new ol.style.Style({stroke:new ol.style.Stroke({color:"rgba(0,0,0,0.3)",width:1}),fill:new ol.style.Fill({color:"rgba(160,0,0,0.9)"})})),E[E.length]=n,E[E.length-1][0]="circle",t.addFeature(n),n},q=function(e,t){var n=i.getSource();p1=e,p2=[e[0],t[1]],p3=t,p4=[t[0],e[1]];var o=[p1,p2,p3,p4,p1],r=new ol.Feature({geometry:new ol.geom.LineString(o)});return r.setStyle(new ol.style.Style({stroke:new ol.style.Stroke({color:"rgba(160,0,0,0.7)",width:2})})),E[E.length]=r,E[E.length-1][0]="square",n.addFeature(r),r},Q=function(e){e&&console&&console.log(e)};return{Init:function(e,t){S=(u=e).getView(),y||(y=t),O(c),F("settings")},IsActive:t,CacheDatabaseExist:function(){return n},Activate:Y,Deactivate:G,StartCaching:function(e,t,n,o){J(e,t,n,o)},StopCaching:function(){w=!0,y.TriggerEvent(ISY.Events.EventTypes.CachingEnd,Z()),G(),S.setZoom(m),S.setCenter(a),u.removeLayer(i)},CalculateTileCount:function(e,t,n){var o=0;if(void 0!==u){var r=n,a=S.getResolution();g=[r[0],r[3]],v=[r[2],r[1]];var i=t-e,s=S.getZoom();e<s&&(a*=Math.pow(2,s-e));for(var l=0;l<i;l++)o+=Math.abs(Math.ceil((v[0]-g[0])/a*Math.pow(2,l+1)/256/2))*Math.abs(Math.ceil((g[1]-v[1])/a*Math.pow(2,l+1)/256/2))}return o},GetResource:function(e,t,n){j(e,t,n,!1)},GetConfigResource:function(e,t,n){N(e,t,n,!0)},GetLayerResource:R,DeleteDatabase:function(n,o,r){A(!1),O(h),I.map&&I.map.destroy(s+h,function(e,t){e?Q("Database destroy error: "+e+" "+t):(Q("Deleted "+s+h+" database."),I.map=void 0,n&&n(o,r))})},GetDatabase:O,GetResourceFromJson:function(e,t,n){N(e,t,n,!1)}}},(ISY=ISY||{}).MapImplementation=ISY.MapImplementation||{},ISY.MapImplementation.OL3=ISY.MapImplementation.OL3||{},ISY.MapImplementation.OL3.PrintBoxSelect=function(i){var s,r=!1,l={},u="",c=25e3,o={},p=4,m=3,a=17.6,f=26.3,n={},d="portrait",g=!0;var v=function(t){n.change_center=t.getView().on("change:center",function(){if(function(e){if(r){var t=h(y(e));return L(t.getCoordinates()[0],t.getCoordinates()[1])===u||(C(e),!1)}}(t)){var e=I(t);w(t,e)}}),n.moveend=t.on("moveend",function(){S(t)})},S=function(e){var t=y(e),n=E(t),o=Y(n),r=M(o,u),a={bbox:[o.left,o.bottom,o.right,o.top],center:n.getCoordinates(),projection:u.localProj,sone:u.sone,biSone:r,scale:c};i.TriggerEvent(ISY.Events.EventTypes.PrintBoxSelectReturnValue,a)},y=function(e){return e.getView().getCenter()},h=function(e){var t=new ol.geom.Point(e);return g&&t.applyTransform(ol.proj.getTransform("EPSG:32633","EPSG:4326")),t},I=function(e){var t=e.getView().getCenter(),n=[t[0]-l[0],t[1]-l[1]];return l=t,n},w=function(e,t){s.getSource().getFeatures()[0].getGeometry().translate(t[0],t[1])},L=function(e,t){var n="32V",o="EPSG:32632";return 72<t?o=e<21?(n="33X","EPSG:32633"):(n="35X","EPSG:32635"):64<t?o=e<6?(n="31W","EPSG:32631"):e<12?(n="32W","EPSG:32632"):e<18?(n="33W","EPSG:32633"):e<24?(n="34W","EPSG:32634"):e<30?(n="35W","EPSG:32635"):(n="36W","EPSG:32636"):e<3?(n="31V",o="EPSG:32631"):12<=e&&(n="33V",o="EPSG:32633"),{sone:n,localProj:o}},M=function(e,t){var n=new ol.geom.Point([e.left,e.bottom]);n.applyTransform(ol.proj.getTransform(t.localProj,"EPSG:4326"));var o=L(n.getCoordinates()[0],n.getCoordinates()[1]).sone;if(o!==t.sone)return o;var r=new ol.geom.Point([e.right,e.top]);r.applyTransform(ol.proj.getTransform(t.localProj,"EPSG:4326"));var a=L(r.getCoordinates()[0],r.getCoordinates()[1]).sone;if(a!==t.sone)return a;var i=new ol.geom.Point([e.right,e.bottom]);i.applyTransform(ol.proj.getTransform(t.localProj,"EPSG:4326"));var s=L(i.getCoordinates()[0],i.getCoordinates()[1]).sone;if(s!==t.sone)return s;var l=new ol.geom.Point([e.right,e.top]);l.applyTransform(ol.proj.getTransform(t.localProj,"EPSG:4326"));var u=L(l.getCoordinates()[0],l.getCoordinates()[1]).sone;return u!==t.sone?u:""},C=function(e){S(e),s&&e.removeLayer(s);var t=y(e),n=Y(E(l=t)),o=x(G(n),t),r=new ol.Feature(o);r.setStyle(O());var a=new ol.source.Vector;a.addFeature(r),s=new ol.layer.Vector({name:"PrintBoxSelect",source:a,updateWhileAnimating:!0,updateWhileInteracting:!0}),e.addLayer(s),s.setZIndex(2e3)},b=function(e){var t=h(e),n=L(t.getCoordinates()[0],t.getCoordinates()[1]);return u=n},x=function(e,t){var n=new ol.geom.MultiPolygon(e);return g&&n.applyTransform(ol.proj.getTransform(b(t).localProj,"EPSG:32633")),n},E=function(e){var t=new ol.geom.Point(e);return g?t.applyTransform(ol.proj.getTransform("EPSG:32633",b(e).localProj)):b(e),t},Y=function(e){var t={};return t.width=c*a*p/100,t.height=c*f*m/100,t.left=e.getCoordinates()[0]-t.width/2,t.right=t.left+t.width,t.bottom=e.getCoordinates()[1]-t.height/2,t.top=t.bottom+t.height,t},G=function(e){for(var t=[],n=e.left,o=1;o<=p;o++){for(var r=n+(e.right-e.left)/p,a=e.bottom,i=1;i<=m;i++){var s=a+(e.top-e.bottom)/m,l=new ol.geom.Point([n,a]),u=new ol.geom.Point([n,s]),c=new ol.geom.Point([r,s]),f=new ol.geom.Point([r,a]),d=new ol.geom.Polygon([[l.getCoordinates(),u.getCoordinates(),c.getCoordinates(),f.getCoordinates(),l.getCoordinates()]]);t.push(d.getCoordinates()),a=s}n=r}return t},O=function(){return new ol.style.Style({stroke:new ol.style.Stroke({color:"#ee9900",width:1,opacity:1}),fill:new ol.style.Fill({color:"rgba(238,153,0,0.4)",opacity:.4})})},T=function(t,n){t.getInteractions().forEach(function(e){e instanceof ol.interaction.DragPan&&(t.removeInteraction(e),n&&(o=e))})};return{Activate:function(e,t){var n,o;r=!0,void 0!==e&&(c=t.scale,p=t.cols,m=t.rows,void 0!==t.orientation&&d!==t.orientation&&(o=a,a=f,f=o),d=t.orientation,g=t.rotation||!0,T(n=e,!0),n.addInteraction(new ol.interaction.DragPan({kinetic:!1})),v(e),C(e))},Deactivate:function(e){var t;r&&(r=!1,void 0!==e&&(e.removeLayer(s),function(){for(var e in n)ol.Observable.unByKey(n[e]),n[e]=!1}(),T(t=e,!1),t.addInteraction(o)))}}},(ISY=ISY||{}).MapImplementation=ISY.MapImplementation||{},ISY.MapImplementation.OL3=ISY.MapImplementation.OL3||{},ISY.MapImplementation.OL3.ProgressBar=function(t){var n,o;function r(){var e=document.getElementById("progressbar");null!=e&&(o=new a(e),n.getLayers().forEach(function(e){var t=e.getSource();if(t)switch(t.get("type")){case"ol.source.Vector":t.on("vectorloadstart",function(){o.addLoading()}),t.on("vectorloadend",function(){o.addLoaded()});break;case"ol.source.ImageWMS":t.on("imageloadstart",function(){o.addLoading()}),t.on("imageloadend",function(){o.addLoaded()}),t.on("imageloaderror",function(){o.addLoaded()});break;case"ol.source.TileWMS":t.on("tileloadstart",function(){o.addLoading()}),t.on("tileloadend",function(){o.addLoaded()}),t.on("tileloaderror",function(){o.addLoaded()})}}))}function a(e){this.el=e,this.loading=0,this.loaded=0}return a.prototype.addLoading=function(){0===this.loading&&this.show(),++this.loading,this.update()},a.prototype.addLoaded=function(){var e=this;++e.loaded,e.loaded>e.loading&&(e.loaded=e.loading),e.update()},a.prototype.update=function(){if(this.el.style.width=(this.loaded/this.loading*100).toFixed(1)+"%",this.loading===this.loaded){this.loading=0,this.loaded=0;var e=this;setTimeout(function(){e.hide()},500)}},a.prototype.show=function(){this.el.style.visibility="visible"},a.prototype.hide=function(){this.loading===this.loaded&&(this.el.style.visibility="hidden",this.el.style.width=0)},{Init:function(e){n=e,t.RegisterEvent(ISY.Events.EventTypes.ChangeLayers,r)}}},(ISY=ISY||{}).MapImplementation=ISY.MapImplementation||{},ISY.MapImplementation.OL3=ISY.MapImplementation.OL3||{},ISY.MapImplementation.OL3.Utilities=function(){return{ConvertGmlToGeoJson:function(e){var t=(new ol.format.WMSCapabilities).read(e),n=(new ol.format.GML).readFeatures(t);return(new ol.format.GeoJSON).writeFeatures(n)},ExtentToGeoJson:function(e,t){var n=new ol.geom.Point([e,t]),o=new ol.Feature;return o.setGeometry(n),(new ol.format.GeoJSON).writeFeature(o)}}},(ISY=ISY||{}).MapImplementation=ISY.MapImplementation||{},ISY.MapImplementation.OL3=ISY.MapImplementation.OL3||{},ISY.MapImplementation.OL3.Sources=ISY.MapImplementation.OL3.Sources||{},ISY.MapImplementation.OL3.Sources.CustomMessageHandler=function(n,o){var r,a,i,s="Service down: ";function l(){var e=document.getElementById("messagecontainer");null!=e&&(a=new t(e),r&&r.getLayers().forEach(function(e){var t=i(e),n=e.getSource();if(n)switch(n.get("type")){case"ol.source.ImageWMS":n.on("imageloaderror",function(e){a.showMessage(t.title,e)});break;case"ol.source.TileWMS":n.on("tileloaderror",function(e){a.showMessage(t.title,e)})}}))}function t(e){this.el=e,this.messages=[],this.looping=!1,this.visible=!1}return t.prototype.showMessage=function(t,e){var n=this;if(t=n.getResponse(t,e),0===n.messages.length)n.messages.push(t);else{var o=!0;n.messages.forEach(function(e){o&&e===t&&(o=!1)}),o&&n.messages.push(t)}n.show()},t.prototype.getResponse=function(e,t){try{var n=t.tile.getImage();if(n&&n.src&&(n.src.toLowerCase().indexOf("&gkt=")<0||n.src.toLowerCase().indexOf("?gkt=")<0)){var o=$.ajax({type:"GET",url:n.src,async:!1}).responseText,r=xml.xmlToJSON(o);if(r&&r.serviceexceptionreport&&r.serviceexceptionreport.serviceexception){var a=r.serviceexceptionreport.serviceexception.split("\n");return e+"<br>"+a[2]+" "+a[3].substr(0,a[3].indexOf(" Token:"))}}}catch(e){return e}return e},t.prototype.show=function(){var e=this;e.visible||(e.visible=!0,e.el.innerHTML="",e.el.style.opacity=1,e.el.style.visibility="visible",e.looping||(e.looping=!0,e.loopMessages()))},t.prototype.hide=function(){var e=this;e.visible&&(e.looping=!1,e.visible=!1,e.el.style.opacity=0,setTimeout(function(){e.el.style.visibility="hidden"},2e3))},t.prototype.loopMessages=function(e){void 0===e&&(e=this),0<e.messages.length?(e.el.innerHTML=s+e.messages.pop(),setTimeout(function(){e.loopMessages(e)},1e3)):e.hide()},{Init:function(e,t){r=e,t&&0<t.length&&(s=t),i=o,n.RegisterEvent(ISY.Events.EventTypes.ChangeLayers,l)},InitMessage:function(e){void 0!==e&&(s=e),l()},ShowCustomMessage:function(e){a&&a.showMessage(e)}}},(ISY=ISY||{}).MapImplementation=ISY.MapImplementation||{},ISY.MapImplementation.OL3=ISY.MapImplementation.OL3||{},ISY.MapImplementation.OL3.Sources=ISY.MapImplementation.OL3.Sources||{},ISY.MapImplementation.OL3.Sources.Vector=function(e){var t;switch(e.format){case ISY.Domain.SubLayer.FORMATS.geoJson:(t=new ol.source.Vector({format:new ol.format.GeoJSON({defaultDataProjection:e.coordinate_system}),url:e.url})).set("type","ol.source.Vector")}return t},(ISY=ISY||{}).MapImplementation=ISY.MapImplementation||{},ISY.MapImplementation.OL3=ISY.MapImplementation.OL3||{},ISY.MapImplementation.OL3.Sources=ISY.MapImplementation.OL3.Sources||{},ISY.MapImplementation.OL3.Sources.Wfs=function(p,r,a,m,g){var e;if(p.tiled){var t=[];t[0]=21664;for(var n=1;n<18;n++)t[n]=t[n-1]/2;e=ol.loadingstrategy.tile(new ol.tilegrid.TileGrid({origin:[0,0,0],resolutions:t}))}else e=ol.loadingstrategy.bbox;var o=ol.proj.get(p.coordinate_system),i=function(e){var t;if(v.dispatchEvent("vectorloadend"),void 0===v.format){var n;switch(p.version){case"1.0.0":n=new ol.format.GML2;break;case"1.1.0":case"2.0.0":n=new ol.format.GML3;break;default:n=new ol.format.GML}p.srs_dimension&&0<p.srs_dimension.length?(t=e.firstChild.firstElementChild.firstElementChild.namespaceURI,v.format=new ol.format.WFS({featureType:e.firstChild.firstElementChild.firstElementChild.localName,featureNS:t,gmlFormat:n})):(t=e.firstChild.namespaceURI,v.format=new ol.format.WFS({featureType:p.name,featureNS:t,gmlFormat:n}))}if("3"===p.srs_dimension&&(t=e.firstChild.firstElementChild.firstElementChild.namespaceURI,"gml:featurecollection"===e.firstChild.nodeName.toLowerCase()))for(var o=0;o<e.firstChild.childNodes.length;o++){var r=e.firstChild.childNodes.item(o);if("gml:featuremember"===r.nodeName.toLowerCase())for(var a=0;a<r.childNodes.length;a++){var i=r.childNodes.item(a);if(i.nodeName.toLowerCase()===p.name.toLowerCase())for(var s=0;s<i.childNodes.length;s++)for(var l=i.childNodes.item(s),u=0;u<l.childNodes.length;u++){var c=l.childNodes.item(u).nodeName;if("gml:linestring"===c.toLowerCase()||"gml:point"===c.toLowerCase()){var f=document.createAttribute("srsDimension");f.value=p.srs_dimension,l.firstElementChild.attributes.setNamedItem(f)}}}}var d=v.format.readFeatures(e);d&&0<d.length&&(d.forEach(function(e){e.set("layerguid",p.id)}),v.addFeatures(d)),0<d.length&&(p.geometryName=d[0].getGeometryName()),p.featureNS=t,m&&g&&g.TriggerEvent(ISY.Events.EventTypes.RefreshSourceDone,m)},v=new ol.source.Vector({loader:function(e){v.dispatchEvent("vectorloadstart");var t=p.url;if(Array.isArray(p.url)&&(t=p.url[0]),t.toLowerCase().indexOf("service=wfs")<0&&(t+="service=WFS&"),t+="request=GetFeature&version="+p.version+"&typename="+p.name+"&srsname="+p.coordinate_system+"&bbox="+e.join(","),a)for(var n in a)t+="&"+n+"="+a[n];if(v.get("caching")||r.IsActive()){var o=e[0]+"-"+e[1];r.GetLayerResource(o,p.name,t,i)}else $.ajax({url:t}).done(function(e){"object"==typeof e&&0!==e.firstChild.childElementCount&&i(e)})},strategy:e,projection:o});return v.set("type","ol.source.Vector"),v},(ISY=ISY||{}).MapImplementation=ISY.MapImplementation||{},ISY.MapImplementation.OL3=ISY.MapImplementation.OL3||{},ISY.MapImplementation.OL3.Sources=ISY.MapImplementation.OL3.Sources||{},ISY.MapImplementation.OL3.Sources.WfsT=function(e,t,n,o,r,c){var f=e,d=t,p=n,m=o,g=r,a=new XMLSerializer;var v="";function S(e){if(0<e.childElementCount)for(var t=0;t<e.childNodes.length;t++){if(v+="<"+e.childNodes[t].nodeName,0<e.childNodes[t].attributes.length)for(var n=0;n<e.childNodes[t].attributes.length;n++){var o=e.childNodes[t].attributes[n];v+=" "+o.name+'="'+o.value+'"'}0<e.childNodes[t].childNodes.length&&(v+=">"),0<e.childNodes[t].childElementCount?S(e.childNodes[t]):0<e.childNodes[t].childNodes.length?(v+=e.childNodes[t].childNodes[0].nodeValue,v+="</"+e.childNodes[t].nodeName+">"):v+="/>"}else{if(v+="<"+e.nodeName,0<e.attributes.length)for(var r=0;r<e.attributes.length;r++){var a=e.attributes[r];v+=" "+a.name+'="'+a.value+'"'}0<e.childNodes[0].childNodes.length?(v+=">",v+=e.childNodes[0].nodeValue,v+="</"+e.nodeName+">"):v+="/>"}v+="</"+e.nodeName+">"}function y(e){var t=e.getElementsByTagName("*"),n="",o=[],r=t[0].parentNode;n+="<"+r.nodeName,o.push(r.nodeName);for(var a=0;a<r.attributes.length;a++){var i=r.attributes[a];n+=" "+i.name+'="'+i.value+'"'}n+=">",n+="<"+t[0].nodeName,o.push(t[0].nodeName);for(var s=0;s<t[0].attributes.length;s++){var l=t[0].attributes[s];n+=" "+l.name+'="'+l.value+'"'}n+=">";for(var u=t[0],c=0;c<u.childElementCount;c++){if(n+="<"+u.childNodes[c].nodeName,0<u.childNodes[c].attributes.length)for(var f=0;f<u.childNodes[c].attributes.length;f++){var d=u.childNodes[c].attributes[f];n+=" "+d.name+'="'+d.value+'"'}n+=">",S(u.childNodes[c]),n+=v,v=""}for(var p=o.length-1;0<=p;p--)n+="</"+o[p]+">";return n}function h(e){return window.Document&&e instanceof Document&&e.documentElement&&"ExceptionReport"===e.documentElement.localName?e.getElementsByTagNameNS("http://www.opengis.net/ows","ExceptionText").item(0).textContent:g.format.readTransactionResponse(e)}function I(e){var t=e.indexOf(":");return-1!==t?(t++,e.substr(t)):e}return{InsertFeature:function(i,e){if(void 0===g.format&&void 0===e)return c.TriggerEvent(ISY.Events.EventTypes.TransactionInsertEnd,!1),!1;void 0!==e&&(g=e);var t=g.format.writeTransaction([i],null,null,{gmlOptions:{srsName:m},featureNS:p,featureType:d}),n=a.serializeToString(t);n=(n=n.replace(/geometry/g,i.getGeometryName())).replace(/&/g,"&amp;");var s="Error inserting feature: ",l=!0;if($.ajax({type:"POST",url:f,data:n,async:!1,success:function(e){var t,n,o=h(e);if(void 0===o)l=!1,s+="Response parse error.";else if("string"==typeof o)l=!1,s+=o;else if(void 0===o.transactionSummary)l=!1;else if(o&&1===o.transactionSummary.totalInserted){var r=o.insertIds[0];i.setId(r);var a=-1!==(n=(t=r).indexOf("{"))?t.substr(n):"";i.set("lokalId",a),g.addFeature(i)}else l=!1,s+="Feature not inserted.";c.TriggerEvent(ISY.Events.EventTypes.TransactionInsertEnd,l)},error:function(e){var t=e?e.status+" "+e.statusText:"";"200 parsererror"===t&&(t="Response parse error."),l=!1,s+=t,c.TriggerEvent(ISY.Events.EventTypes.TransactionInsertEnd,l)}}),!l)throw new Error(s)},UpdateFeature:function(e){if(void 0===g.format)return c.TriggerEvent(ISY.Events.EventTypes.TransactionUpdateEnd,!1),!1;var o=e.getId(),r=e.getProperties();delete r.bbox;var t=new ol.Feature(r);t.setId(o);var n,a,i,s=-1!==(a=(n=d).indexOf(":"))?n.substr(0,a):"";i=(i=(i=(i=(i=(i=(i=""!==s?(i=y(g.format.writeTransaction(null,[t],null,{gmlOptions:{srsName:m},featureNS:p,featureType:I(d),featurePrefix:s}))).replace(/<Name>/g,"<Name>"+s+":"):y(g.format.writeTransaction(null,[t],null,{gmlOptions:{srsName:m},featureNS:p,featureType:I(d)}))).replace('xsi:schemaLocation="http://www.opengis.net/wfs http://schemas.opengis.net/wfs/1.1.0/wfs.xsd"','xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.opengis.net/wfs http://schemas.opengis.net/wfs/1.1.0/wfs.xsd" xmlns="http://www.opengis.net/wfs"')).replace("Filter",'Filter xmlns="http://www.opengis.net/ogc"')).replace("Point",'Point xmlns="http://www.opengis.net/gml"')).replace("Polygon",'Polygon xmlns="http://www.opengis.net/gml"')).replace("LineString",'LineString xmlns="http://www.opengis.net/gml"')).replace(/&/g,"&amp;");var l="Error updating feature: ",u=!0;if($.ajax({type:"POST",url:f,data:i,success:function(e){var t=h(e);if(void 0===t)u=!1,l+="Response parse error.";else if("string"==typeof t)u=!1,l+=t;else if(void 0===t.transactionSummary)u=!1;else if(t&&void 0===t.transactionSummary.totalUpdated)u=!1,l+="Response parse error.";else if(t&&1!==t.transactionSummary.totalUpdated)u=!1,l+="Feature not updated.";else{var n=g.getFeatureById(o);void 0!==n&&n.setProperties(r)}c.TriggerEvent(ISY.Events.EventTypes.TransactionUpdateEnd,u)},error:function(e){var t=e?e.status+" "+e.statusText:"";"200 parsererror"===t&&(t="Response parse error."),u=!1,l+=t,c.TriggerEvent(ISY.Events.EventTypes.TransactionUpdateEnd,u)}}),!u)throw new Error(l)},DeleteFeature:function(e){if(void 0===g.format)return c.TriggerEvent(ISY.Events.EventTypes.TransactionRemoveEnd,!1),!1;var t=y(g.format.writeTransaction(null,null,[e],{featureNS:p,featureType:I(d)}));t=(t=t.replace('xsi:schemaLocation="http://www.opengis.net/wfs http://schemas.opengis.net/wfs/1.1.0/wfs.xsd"','xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.opengis.net/wfs http://schemas.opengis.net/wfs/1.1.0/wfs.xsd" xmlns="http://www.opengis.net/wfs"')).replace("Filter",'Filter xmlns="http://www.opengis.net/ogc"');var n="Error deleting feature: ",o=!0;if($.ajax({type:"POST",url:f,data:t,success:function(e){var t=h(e);void 0===t?(o=!1,n+="Response parse error."):"string"==typeof t?(o=!1,n+=t):void 0===t.transactionSummary?o=!1:t&&1!==t.transactionSummary.totalDeleted&&(o=!1,n+="Feature not deleted."),c.TriggerEvent(ISY.Events.EventTypes.TransactionRemoveEnd,o)},error:function(e){var t=e?e.status+" "+e.statusText:"";"200 parsererror"===t&&(t="Response parse error."),o=!1,n+=t,c.TriggerEvent(ISY.Events.EventTypes.TransactionRemoveEnd,o)}}),!o)throw new Error(n)},GetFeatureType:function(){return d}}},(ISY=ISY||{}).MapImplementation=ISY.MapImplementation||{},ISY.MapImplementation.OL3=ISY.MapImplementation.OL3||{},ISY.MapImplementation.OL3.Sources=ISY.MapImplementation.OL3.Sources||{},ISY.MapImplementation.OL3.Sources.Wms=function(e,o){var t,n,r,a=function(e){var t="";if(o){for(var n in o)0<t.length&&(t+="&"),t+=n+"="+o[n];0<e.indexOf("?")?e+="&":e+="?",e+=t}return e};if(Array.isArray(e.url)){n=e.url;for(var i=0;i<n.length;i++)n[i]=a(n[i])}else t=a(t=e.url);return e.tiled?(r=new ol.source.TileWMS({params:{LAYERS:e.name,VERSION:"1.1.1",FORMAT:e.format,STYLES:e.styles||""},url:t,urls:n,crossOrigin:e.crossOrigin,transparent:e.transparent,minResolution:e.minResolution,maxResolution:e.maxResolution})).set("type","ol.source.TileWMS"):(void 0===t&&(t=n[n.length-1]),(r=new ol.source.ImageWMS({params:{LAYERS:e.name,VERSION:"1.1.1",FORMAT:e.format,STYLES:e.styles||""},ratio:1,url:t,crossOrigin:e.crossOrigin,transparent:e.transparent,minResolution:e.minResolution,maxResolution:e.maxResolution})).set("type","ol.source.ImageWMS")),r},(ISY=ISY||{}).MapImplementation=ISY.MapImplementation||{},ISY.MapImplementation.OL3=ISY.MapImplementation.OL3||{},ISY.MapImplementation.OL3.Sources=ISY.MapImplementation.OL3.Sources||{},ISY.MapImplementation.OL3.Sources.Wmts=function(t,n){var e=new ol.proj.Projection({code:t.coordinate_system,extent:t.extent,units:t.extentUnits}),o=function(){var e="";if(n)for(var t in n)e+="&"+t+"="+n[t];return e},r=t.matrixSet;null!==r&&""!==r&&void 0!==r||(r=t.matrixPrefix?t.coordinate_system:parseInt(t.coordinate_system.substr(t.coordinate_system.indexOf(":")+1),10));for(var a,i,s=t.url,l=0;l<s.length;l++)s[l]+=o();var u=e.getExtent(),c=t.wmtsExtent?t.wmtsExtent.split(","):u;if(t.getCapabilities){var f=s[0]+"&Request=GetCapabilities&Service=WMTS&Version=1.0.0",d=$.ajax({type:"GET",url:f,async:!1}).responseText;(d=(new ol.format.WMTSCapabilities).read(d)).Contents.Layer.forEach(function(e){e.Identifier===t.name&&(e.WGS84BoundingBox=void 0)}),(i=ol.source.WMTS.optionsFromCapabilities(d,{layer:t.name,matrixSet:r,requestEncoding:"KVP"})).tileGrid=new ol.tilegrid.WMTS({extent:c,origin:i.tileGrid.getOrigin(0),resolutions:i.tileGrid.getResolutions(),matrixIds:i.tileGrid.getMatrixIds(),tileSize:i.tileGrid.getTileSize(0)})}else{for(var p=ol.extent.getWidth(u)/256,m=new Array(t.numZoomLevels),g=new Array(t.numZoomLevels),v=0;v<t.numZoomLevels;++v)m[v]=p/Math.pow(2,v),g[v]=t.matrixPrefix?r+":"+v:g[v]=v;i={layer:t.name,format:t.format,matrixSet:r,crossOrigin:t.crossOrigin,tileGrid:new ol.tilegrid.WMTS({extent:c,origin:ol.extent.getTopLeft(u),resolutions:m,matrixIds:g}),style:"default",wrapX:!0}}return i.projection=e,i.urls=s,(a=new ol.source.WMTS(i)).set("type","ol.source.WMTS"),a},(ISY=ISY||{}).MapImplementation=ISY.MapImplementation||{},ISY.MapImplementation.OL3=ISY.MapImplementation.OL3||{},ISY.MapImplementation.OL3.Styles=ISY.MapImplementation.OL3.Styles||{},ISY.MapImplementation.OL3.Styles.Default=function(){return{Styles:function(){var e=new ol.style.Fill({color:"rgba(255,0,0,0.8)"}),t=new ol.style.Stroke({color:"#3399CC",width:2.25});return[new ol.style.Style({image:new ol.style.Circle({fill:e,stroke:t,radius:8}),fill:e,stroke:t})]}}},(ISY=ISY||{}).MapImplementation=ISY.MapImplementation||{},ISY.MapImplementation.OL3=ISY.MapImplementation.OL3||{},ISY.MapImplementation.OL3.Styles=ISY.MapImplementation.OL3.Styles||{},ISY.MapImplementation.OL3.Styles.Json=function(n){var a=0;function o(e,t,n){var o="object"==typeof t?t:JSON.parse(t),r=[];return a++,r.push(new ol.style.Style({fill:i(o),icon:function(e){if(e.icon)return new ol.style.Icon(e.icon)}(o),image:function(e,t){{if(e.image)return new ol.style.Circle({radius:t?1.2*e.image.radius:e.image.radius,fill:i(e.image),stroke:s(e.image)});if(e.regularshape){var n=parseInt(e.regularshape.angle,10),o=parseInt(e.regularshape.rotation,10);return new ol.style.RegularShape({fill:i(e.regularshape),stroke:s(e.regularshape),radius:t?1.2*e.regularshape.radius:e.regularshape.radius,radius2:t?1.2*e.regularshape.radius2:e.regularshape.radius2,points:e.regularshape.points,rotation:0<o?Math.PI/o:0,angle:0<n?Math.PI/n:0})}}}(o,n),stroke:s(o,n),text:function(e,t,n){if(t.text)return n&&(t.text.scale&&(t.text.scale*=1.2),t.text.rotation&&(t.text.rotation*=-1)),new ol.style.Text({font:t.text.font,offsetX:t.text.offsetX,offsetY:t.text.offsetY,scale:t.text.scale,rotation:t.text.rotation,text:function(e,t){if(t){var n=t.indexOf("{");if(n<0)return t;if("{_id}"==t)return e.getId();for(var o="";0<=n;){0<n&&(o+=t.substr(0,n),t=t.slice(n),n=t.indexOf("{"));var r=t.indexOf("}"),a=t.substr(n+1,r-n-1),i=e.get(a);i&&(o+=i),t=t.slice(r+1),n=t.indexOf("{")}return o+t}}(e,t.text.text),textAlign:t.text.textAlign,textBaseline:t.text.textBaseline,fill:i(t.text),stroke:s(t.text)})}(e,o,n),zIndex:a})),r}function i(e){if(e.fill)return new ol.style.Fill(e.fill)}function s(e,t){if(e.stroke)return t&&(e.stroke.width*=2),new ol.style.Stroke(e.stroke)}return{GetStyle:function(e){if(e){var t=e.getProperties();return t.style?void e.setStyle(o(e,t.style)):o(e,n)}},GetHoverStyle:function(e){if(e)return o(e,n,!0)}}},(ISY=ISY||{}).MapImplementation=ISY.MapImplementation||{},ISY.MapImplementation.OL3=ISY.MapImplementation.OL3||{},ISY.MapImplementation.OL3.Styles=ISY.MapImplementation.OL3.Styles||{},ISY.MapImplementation.OL3.Styles.Measure=function(){return{DrawStyles:function(){return new ol.style.Style({fill:new ol.style.Fill({color:"rgba(255, 255, 255, 0.5)"}),stroke:new ol.style.Stroke({color:"rgba(160, 0, 0, 0.5)",width:2}),image:new ol.style.Circle({radius:5,fill:new ol.style.Fill({color:"rgba(160, 0, 0, 0.8)"}),stroke:new ol.style.Stroke({color:"rgba(255, 255, 255, 0.8)",width:2})})})},Styles:function(){return new ol.style.Style({fill:new ol.style.Fill({color:"rgba(255, 255, 255, 0.8)"}),stroke:new ol.style.Stroke({color:"#ffcc33",width:2}),image:new ol.style.Circle({radius:7,fill:new ol.style.Fill({color:"#ffcc33"})})})}}},(ISY=ISY||{}).MapImplementation=ISY.MapImplementation||{},ISY.MapImplementation.OL3=ISY.MapImplementation.OL3||{},ISY.MapImplementation.OL3.Styles=ISY.MapImplementation.OL3.Styles||{},ISY.MapImplementation.OL3.Styles.Sld=function(){var u,c=[new ol.style.Style({fill:new ol.style.Fill({color:"rgba(255, 255, 255, 0.6)"}),stroke:new ol.style.Stroke({color:"#319FD3",width:2}),image:new ol.style.Circle({radius:3,fill:new ol.style.Fill({color:"rgba(255, 255, 255, 0.6)"}),stroke:new ol.style.Stroke({color:"#319FD3",width:2})}),text:new ol.style.Text({font:"12px Calibri,sans-serif",fill:new ol.style.Fill({color:"#000"}),stroke:new ol.style.Stroke({color:"#fff",width:3})})})],f=function(e,t){if(void 0===t)return!1;if(void 0===e)return!0;if(void 0===e.filters)return function(e,t){if(void 0===t)return!1;if(void 0===e)return!1;var n,o,r=!1;if(n=t.get(e.property))switch(e.operator){case"==":switch(typeof n){case"string":r=n===(o=e.value);break;case"number":o=parseInt(e.value,10),r=parseInt(n,10)===o}break;case">":o=parseInt(e.value,10),r=parseInt(n,10)>o;break;case"<":o=parseInt(e.value,10),r=parseInt(n,10)<o;break;case">=":o=parseInt(e.value,10),r=parseInt(n,10)>=o;break;case"<=":o=parseInt(e.value,10),r=parseInt(n,10)<=o;break;case"!=":switch(typeof n){case"string":r=n!==(o=e.value);break;case"number":o=parseInt(e.value,10),r=parseInt(n,10)!==o}break;case"NULL":switch(typeof n){case"string":r=0===n.length;break;case"number":o=parseInt(e.value,10),r=parseInt(n,10)!==o}break;case"..":r=(n=parseInt(n,10))>=parseInt(e.lowerBoundary,10)&&n<=parseInt(e.upperBoundary,10)}else switch(e.operator){case"NULL":r=!0}return r}(e,t);if(e.filters.length<=1)return!0;var n,o=!1;switch(e.filters[0]){case"&&":for(n=1;n<e.filters.length&&(o=f(e.filters[n],t));n++);break;case"||":for(n=1;n<e.filters.length&&!(o=f(e.filters[n],t));n++);}return o},o=function(n,o,r){void 0===r&&(r=!1);var a,i,s,e,t,l=[];return u?($(u.namedLayers[0].userStyles).each(function(e,t){r&&!t.isDefault?f(t.rule.filter,n)&&p(t.rule,o)&&((a=t.style.getText())?(i=a.getText(),a=angular.copy(t.style),s=d(i,n),a.getText().setText(s)):l.push(t.style)):!r&&t.isDefault&&f(t.rule.filter,n)&&p(t.rule,o)&&((a=t.style.getText())?(i=a.getText(),a=angular.copy(t.style),s=d(i,n),a.getText().setText(s)):l.push(t.style))}),a&&l.push(a),0<l.length?l:void(r||(t=!0,void 0===(e=n).get("isHidden")&&e.set("isHidden",t)))):c},d=function(e,t){return 0<=e.indexOf("${")&&0<=(e=e.slice(e.indexOf("${")+2)).indexOf("}")&&(e=e.slice(0,e.indexOf("}"))),t.get(e)},p=function(e,t){if(void 0===e)return!0;var n=e.maxScaleDenominator?e.maxScaleDenominator:1/0,o=e.minScaleDenominator?e.minScaleDenominator:1;return t<=n&&o<=t};return{Sld:u,Styles:c,ParseSld:function(e,o){if(void 0===e)return c;"string"==typeof e&&(e=ol.xml.parse(e)),u={namedLayers:[]},this.readChildNodes(e,u),c=[];var r={maxScaleDenominator:1,minScaleDenominator:1/0};return $(u.namedLayers[0].userStyles).each(function(e,t){var n=t.style;o&&n.setZIndex(o),c.push(n),t.rule&&(t.rule.maxScaleDenominator&&r.maxScaleDenominator<t.rule.maxScaleDenominator&&(r.maxScaleDenominator=t.rule.maxScaleDenominator),t.rule.minScaleDenominator&&r.minScaleDenominator>t.rule.minScaleDenominator&&(r.minScaleDenominator=t.rule.minScaleDenominator))}),1===r.maxScaleDenominator&&(r.maxScaleDenominator=void 0),r.minScaleDenominator===1/0&&(r.minScaleDenominator=void 0),r},GetStyle:function(e,t){return o(e,t)},GetStyleForLegend:function(){if(u)return $(u.namedLayers[0].userStyles)},GetHoverStyle:function(e,t){var n=o(e,t,!0);return void 0===n&&(n=o(e,t)),n},defaultPrefix:"sld",namespaces:{sld:"http://www.opengis.net/sld",ogc:"http://www.opengis.net/ogc",gml:"http://www.opengis.net/gml",xlink:"http://www.w3.org/1999/xlink",xsi:"http://www.w3.org/2001/XMLSchema-instance"},namespaceAlias:{"http://www.opengis.net/sld":"sld","http://www.opengis.net/ogc":"ogc","http://www.opengis.net/gml":"gml","http://www.w3.org/1999/xlink":"xlink","http://www.w3.org/2001/XMLSchema-instance":"xsi"},getChildValue:function(e,t){var n=t||"";if(e)for(var o=e.firstChild;o;o=o.nextSibling)switch(o.nodeType){case 3:case 4:n+=o.nodeValue}return n},readChildNodes:function(e,t){t||(t={});for(var n,o=e.childNodes,r=0,a=o.length;r<a;++r)1===(n=o[r]).nodeType&&this.readNode(n,t);return t},readNode:function(e,t){t||(t={});var n=this.readers[e.namespaceURI?this.namespaceAlias[e.namespaceURI]:this.defaultPrefix];if(n){var o=n[e.localName||e.nodeName.split(":").pop()]||n["*"];o&&o.apply(this,[e,t])}return t},readers:{sld:{StyledLayerDescriptor:function(e,t){t.version=e.getAttribute("version"),this.readChildNodes(e,t)},Name:function(e,t){t.name=this.getChildValue(e)},Title:function(e,t){t.title=this.getChildValue(e)},Abstract:function(e,t){t.description=this.getChildValue(e)},NamedLayer:function(e,t){var n={userStyles:[],namedStyles:[]};this.readChildNodes(e,n);for(var o=0,r=n.userStyles.length;o<r;++o)n.userStyles[o].layerName=n.name;Array.isArray(t.namedLayers)?t.namedLayers.push(n):t.namedLayers[n.name]=n},NamedStyle:function(e,t){t.namedStyles.push(this.getChildName(e.firstChild))},UserStyle:function(e,c){var f,d=this,t={defaultsPerSymbolizer:!0,rules:[]};this.featureTypeCounter=-1,this.readChildNodes(e,t);var p=!!t.isDefault&&t.isDefault;this.multipleSymbolizers?(delete t.defaultsPerSymbolizer,f=new ol.style.Style(t)):$(t.rules).each(function(e,t){var n,o,r,a=t.symbolizer.Polygon,i=t.symbolizer.Point,s=t.symbolizer.Line,l=t.symbolizer.Text;if(a)a.fill&&(n=new ol.style.Fill({color:d.getColorValue(a.fillColor,a.fillOpacity)})),a.stroke&&void 0!==a.strokeColor&&void 0!==a.strokeWidth&&(o=new ol.style.Stroke({color:d.getColorValue(a.strokeColor,a.strokeOpacity),width:parseInt(a.strokeWidth.trim(),10),lineDash:a.strokeDashstyle?a.strokeDashstyle.split(" "):void 0}));else if(i){if(i.fill&&(n=new ol.style.Fill({color:d.getColorValue(i.fillColor,i.fillOpacity)})),i.stroke&&(void 0===i.strokeColor&&void 0===i.strokeWidth||(o=new ol.style.Stroke({color:d.getColorValue(i.strokeColor,i.strokeOpacity),width:i.strokeWidth?parseInt(i.strokeWidth.trim(),10):void 0,lineDash:i.strokeDashstyle?i.strokeDashstyle.split(" "):void 0}))),i.label&&(void 0===i.outlineColor&&(i.outlineColor="#ffffff"),void 0===i.outlineWidth&&(i.outlineWidth="3"),l=new ol.style.Text({textAlign:d.getAlignValue(i.labelAnchorPointX),textBaseline:d.getBaselineValue(i.labelAnchorPointY),font:d.getFontValue(i),text:i.label,fill:new ol.style.Fill({color:d.getColorValue(i.fontColor,i.fontOpacity)}),stroke:new ol.style.Stroke({color:i.outlineColor?d.getColorValue(i.outlineColor):d.getColorValue(i.fontColor,i.fontOpacity),width:i.outlineWidth?parseInt(i.outlineWidth,10):void 0}),offsetX:i.labelXOffset?parseInt(i.labelXOffset,10):void 0,offsetY:i.labelYOffset?parseInt(i.labelYOffset,10):void 0,rotation:i.rotation?parseFloat(i.rotation):void 0})),i.graphic)if(i.externalGraphic){var u=i.fillOpacity?parseFloat(i.fillOpacity):void 0;r=new ol.style.Icon({opacity:u,src:i.externalGraphic}),o=n=void 0}else switch(i.graphicName){case"circle":r=new ol.style.Circle({radius:parseInt(i.pointRadius,10),stroke:o,fill:n});break;case"cross":r=new ol.style.RegularShape({radius:parseInt(i.pointRadius,10),radius2:0,points:4,stroke:o,fill:n});break;case"star":r=new ol.style.RegularShape({radius:parseInt(i.pointRadius,10),radius2:parseInt(i.pointRadius,10)/3,points:5,stroke:o,fill:n});break;case"square":r=new ol.style.RegularShape({radius:parseInt(i.pointRadius,10),points:4,angle:Math.PI/4,stroke:o,fill:n});break;case"triangle":r=new ol.style.RegularShape({radius:parseInt(i.pointRadius,10),points:3,stroke:o,fill:n});break;case"x":r=new ol.style.RegularShape({radius:parseInt(i.pointRadius,10),radius2:0,points:4,angle:Math.PI/4,stroke:o,fill:n})}}else s&&(s.fill&&(n=new ol.style.Fill({color:d.getColorValue(s.fillColor,s.fillOpacity)})),s.stroke&&(o=new ol.style.Stroke({color:d.getColorValue(s.strokeColor,s.strokeOpacity),width:d.getStrokeWidth(s.strokeWidth),lineDash:d.getStrokeDashstyle(s.strokeDashstyle)})),s.graphic&&"circle"===s.graphicName&&(r=new ol.style.Circle({radius:parseInt(s.pointRadius,10),fill:n}),n=void 0));f=new ol.style.Style({fill:n,image:r,stroke:o}),c.userStyles.push({isDefault:p,style:f,rule:t}),l&&(f=new ol.style.Style({text:l}),c.userStyles.push({isDefault:p,style:f,rule:t}))})},IsDefault:function(e,t){"1"===this.getChildValue(e)&&(t.isDefault=!0)},FeatureTypeStyle:function(e,t){++this.featureTypeCounter;var n={rules:this.multipleSymbolizers?t.rules:[]};this.readChildNodes(e,n),this.multipleSymbolizers||(t.rules=n.rules)},Rule:function(e,t){var n={symbolizer:[],symbolizer:{fill:!1,stroke:!1,graphic:!1}};this.readChildNodes(e,n),t.rules.push(n)},ElseFilter:function(e,t){t.elseFilter=!0},MinScaleDenominator:function(e,t){t.minScaleDenominator=parseFloat(this.getChildValue(e))},MaxScaleDenominator:function(e,t){t.maxScaleDenominator=parseFloat(this.getChildValue(e))},LabelPlacement:function(e,t){this.readChildNodes(e,t)},PointPlacement:function(e,t){var n={};this.readChildNodes(e,n),n.labelRotation=n.rotation,delete n.rotation;var o,r=t.labelAnchorPointX,a=t.labelAnchorPointY;r<=1/3?o="l":1/3<r&&r<2/3?o="c":2/3<=r&&(o="r"),a<=1/3?o+="b":1/3<a&&a<2/3?o+="m":2/3<=a&&(o+="t"),n.labelAlign=o,console.error("PointPlacement is not implemented")},AnchorPoint:function(e,t){this.readChildNodes(e,t)},AnchorPointX:function(e,t){var n=this.readers.ogc._expression.call(this,e);n&&(t.labelAnchorPointX=n)},AnchorPointY:function(e,t){var n=this.readers.ogc._expression.call(this,e);n&&(t.labelAnchorPointY=n)},Displacement:function(e,t){this.readChildNodes(e,t)},DisplacementX:function(e,t){var n=this.readers.ogc._expression.call(this,e);n&&(t.labelXOffset=n)},DisplacementY:function(e,t){var n=this.readers.ogc._expression.call(this,e);n&&(t.labelYOffset=n)},LinePlacement:function(e,t){this.readChildNodes(e,t)},PerpendicularOffset:function(e,t){var n=this.readers.ogc._expression.call(this,e);n&&(t.labelPerpendicularOffset=n)},Label:function(e,t){var n=this.readers.ogc._expression.call(this,e);n&&(t.label=n)},Font:function(e,t){this.readChildNodes(e,t)},Halo:function(e,t){var n={};this.readChildNodes(e,n),t.haloRadius=n.haloRadius,t.haloColor=n.fillColor,t.haloOpacity=n.fillOpacity},Radius:function(e,t){var n=this.readers.ogc._expression.call(this,e);null!==n&&(t.haloRadius=n)},RasterSymbolizer:function(e,t){var n={};this.readChildNodes(e,n),this.multipleSymbolizers?(n.zIndex=this.featureTypeCounter,t.symbolizers.push(new OpenLayers.Symbolizer.Raster(n))):t.symbolizer.Raster=OpenLayers.Util.applyDefaults(n,t.symbolizer.Raster)},Geometry:function(e,t){t.geometry={},this.readChildNodes(e,t.geometry)},ColorMap:function(e,t){t.colorMap=[],this.readChildNodes(e,t.colorMap)},ColorMapEntry:function(e,t){var n=e.getAttribute("quantity"),o=e.getAttribute("opacity");t.push({color:e.getAttribute("color"),quantity:null!==n?parseFloat(n):void 0,label:e.getAttribute("label")||void 0,opacity:null!==o?parseFloat(o):void 0})},LineSymbolizer:function(e,t){var n={};this.readChildNodes(e,n),this.multipleSymbolizers?(n.zIndex=this.featureTypeCounter,t.symbolizers.push(new OpenLayers.Symbolizer.Line(n))):t.symbolizer.Line=n},PolygonSymbolizer:function(e,t){var n={fill:!1,stroke:!1};this.multipleSymbolizers||(n=t.symbolizer.Polygon||n),this.readChildNodes(e,n),this.multipleSymbolizers?(n.zIndex=this.featureTypeCounter,t.symbolizers.push(new OpenLayers.Symbolizer.Polygon(n))):t.symbolizer.Polygon=n},PointSymbolizer:function(e,t){var n={fill:!1,stroke:!1,graphic:!1};this.multipleSymbolizers||(n=t.symbolizer.Point||n),this.readChildNodes(e,n),this.multipleSymbolizers?(n.zIndex=this.featureTypeCounter,t.symbolizers.push(new OpenLayers.Symbolizer.Point(n))):t.symbolizer.Point=n},TextSymbolizer:function(e,t){var n={};this.readChildNodes(e,n),this.multipleSymbolizers?(n.zIndex=this.featureTypeCounter,t.symbolizers.push(new OpenLayers.Symbolizer.Text(n))):t.symbolizer.Text=n},Stroke:function(e,t){t.stroke=!0,this.readChildNodes(e,t)},Fill:function(e,t){t.fill=!0,this.readChildNodes(e,t)},CssParameter:function(e,t){var n=e.getAttribute("name"),o=this.cssMap[n];if(t.label&&("fill"===n?o="fontColor":"fill-opacity"===n&&(o="fontOpacity")),o){var r=this.readers.ogc._expression.call(this,e);r&&(t[o]=r)}},Graphic:function(e,t){t.graphic=!0;var n={};this.readChildNodes(e,n);for(var o,r,a=["stroke","strokeColor","strokeWidth","strokeOpacity","strokeLinecap","fill","fillColor","fillOpacity","graphicName","rotation","graphicFormat"],i=0,s=a.length;i<s;++i)void 0!==(r=n[o=a[i]])&&(t[o]=r);(void 0!==n.opacity&&(t.graphicOpacity=n.opacity),void 0!==n.size)&&(isNaN(n.size/2)?t.graphicWidth=n.size:t.pointRadius=n.size/2);void 0!==n.href&&(t.externalGraphic=n.href),void 0!==n.rotation&&(t.rotation=n.rotation)},ExternalGraphic:function(e,t){this.readChildNodes(e,t)},Mark:function(e,t){this.readChildNodes(e,t)},WellKnownName:function(e,t){t.graphicName=this.getChildValue(e)},Opacity:function(e,t){var n=this.readers.ogc._expression.call(this,e);n&&(t.opacity=n)},Size:function(e,t){var n=this.readers.ogc._expression.call(this,e);n&&(t.size=n)},Rotation:function(e,t){var n=this.readers.ogc._expression.call(this,e);n&&(t.rotation=n)},OnlineResource:function(e,t){t.href=this.getAttributeNS(e,this.namespaces.xlink,"href")},Format:function(e,t){t.graphicFormat=this.getChildValue(e)}},ogc:{_expression:function(e){for(var t,n="",o=e.firstChild;o;o=o.nextSibling)switch(o.nodeType){case 1:(t=this.readNode(o)).property?n+="${"+t.property+"}":void 0!==t.value&&(n+=t.value);break;case 3:case 4:n+=o.nodeValue}return n},Filter:function(e,t){var n={fids:[],filters:[]};this.readChildNodes(e,n),0<n.fids.length?t.filter={fids:n.fids}:0<n.filters.length&&(t.filter=n.filters[0])},FeatureId:function(e,t){var n=e.getAttribute("fid");n&&t.fids.push(n)},And:function(e,t){var n={filters:["&&"]};this.readChildNodes(e,n),t.filters.push(n)},Or:function(e,t){var n={filters:["||"]};this.readChildNodes(e,n),t.filters.push(n)},Not:function(e,t){var n={filters:["!"]};this.readChildNodes(e,n),t.filters.push(n)},PropertyIsLike:function(e,t){var n={operator:"=="};this.readChildNodes(e,n),t.filters.push(n)},PropertyIsEqualTo:function(e,t){var n={operator:"=="};this.readChildNodes(e,n),t.filters.push(n)},PropertyIsNotEqualTo:function(e,t){var n={operator:"!="};this.readChildNodes(e,n),t.filters.push(n)},PropertyIsLessThan:function(e,t){var n={operator:"<"};this.readChildNodes(e,n),t.filters.push(n)},PropertyIsGreaterThan:function(e,t){var n={operator:">"};this.readChildNodes(e,n),t.filters.push(n)},PropertyIsLessThanOrEqualTo:function(e,t){var n={operator:"<="};this.readChildNodes(e,n),t.filters.push(n)},PropertyIsGreaterThanOrEqualTo:function(e,t){var n={operator:">="};this.readChildNodes(e,n),t.filters.push(n)},PropertyIsBetween:function(e,t){var n={operator:".."};this.readChildNodes(e,n),t.filters.push(n)},Literal:function(e,t){t.value=this.getChildValue(e)},PropertyName:function(e,t){t.property=this.getChildValue(e)},LowerBoundary:function(e,t){t.lowerBoundary=this.readers.ogc._expression.call(this,e)},UpperBoundary:function(e,t){t.upperBoundary=this.readers.ogc._expression.call(this,e)},PropertyIsNull:function(e,t){var n={operator:"NULL"};this.readChildNodes(e,n),t.filters.push(n)}}},cssMap:{stroke:"strokeColor","stroke-opacity":"strokeOpacity","stroke-width":"strokeWidth","stroke-linecap":"strokeLinecap","stroke-dasharray":"strokeDashstyle",fill:"fillColor","fill-opacity":"fillOpacity","font-family":"fontFamily","font-size":"fontSize","font-weight":"fontWeight","font-style":"fontStyle"},getCssProperty:function(e){var t=null;for(var n in this.cssMap)if(this.cssMap[n]===e){t=n;break}return t},getAttributeNodeNS:function(e,t,n){var o=null;if(e.getAttributeNodeNS)o=e.getAttributeNodeNS(t,n);else for(var r,a=e.attributes,i=0,s=a.length;i<s;++i)if((r=a[i]).namespaceURI===t&&(r.prefix?r.prefix+":"+n:n)===r.nodeName){o=r;break}return o},getAttributeNS:function(e,t,n){var o="";if(e.getAttributeNS)o=e.getAttributeNS(t,n)||"";else{var r=this.getAttributeNodeNS(e,t,n);r&&(o=r.nodeValue)}return o},pixelRatio:1,getStrokeDashstyle:function(e){if(e){e=e.split(" ");for(var t=0;t<e.length;t++)e[t]=parseInt(e[t],10)*this.pixelRatio;return e}},getStrokeWidth:function(e){return parseInt(e.trim(),10)*this.pixelRatio},getFontValue:function(e){var t=this,n="";return n=t.addFontValue(n,e.fontStyle),n=t.addFontValue(n,e.fontWeight),e.fontSize&&(e.fontSize.indexOf("px")<0?(n=t.addFontValue(n,e.fontSize),n+="px"):n=t.addFontValue(n,e.fontSize)),(n=t.addFontValue(n,e.fontFamily)).trim()},addFontValue:function(e,t){return void 0===t?e:(0<e.length&&(e+=" "),e+t)},getAlignValue:function(e){if(void 0===e)return"center";var t=parseFloat(e);return 0===t?"left":0<t&&t<1?"center":"right"},getBaselineValue:function(e){if(void 0===e)return"middle";var t=parseFloat(e);return 0===t?"bottom":0<t&&t<1?"middle":"top"},getColorValue:function(e,t){void 0===e&&(e="#000000");var n=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e.trim());if(!(n.length<4))return{r:parseInt(n[1],16),g:parseInt(n[2],16),b:parseInt(n[3],16),a:t?parseFloat(t.trim()):1,getValue:function(){return[this.r,this.g,this.b,this.a]}}.getValue()},getGraphicFormat:function(e){var t;for(var n in this.graphicFormats)if(this.graphicFormats[n].test(e)){t=n;break}return t||this.defaultGraphicFormat},defaultGraphicFormat:"image/png",graphicFormats:{"image/jpeg":/\.jpe?g$/i,"image/gif":/\.gif$/i,"image/png":/\.png$/i},multipleSymbolizers:!1,featureTypeCounter:null,defaultSymbolizer:{fillColor:"#808080",fillOpacity:1,strokeColor:"#000000",strokeOpacity:1,strokeWidth:1,pointRadius:3,graphicName:"square"}}},(ISY=ISY||{}).Repository=ISY.Repository||{},ISY.Repository.Category=function(e){return $.extend({},{catId:"",name:"",parentId:"",subCategories:[],isOpen:!1},e)},(ISY=ISY||{}).Repository=ISY.Repository||{},ISY.Repository.ConfigRepository=function(t,n){return{GetMapConfig:function(e){t.GetMapConfig(e,function(e){var t=function(e){var t={numZoomLevels:18,newMaxRes:21664,center:[570130,7032300],zoom:4,extent:[-2e6,35e5,3545984,9045984],layers:[],proxyHost:"http://geoinnsyn.norconsultad.com/services/isy.gis.isyproxy/?",tools:[]};$.extend(t,e);for(var n=[],o=0;o<e.layers.length;o++)n.push(new ISY.Domain.Layer(e.layers[o]));return t.layers=n,new ISY.Repository.MapConfig(t)}(e);n.TriggerEvent(ISY.Events.EventTypes.MapConfigLoaded,t)})},GetMapConfigFromJson:function(e){n.TriggerEvent(ISY.Events.EventTypes.MapConfigLoaded,e)}}},(ISY=ISY||{}).Repository=ISY.Repository||{},ISY.Repository.MapConfig=function(e){return $.extend({},{name:"",comment:"",useCategories:!0,categories:[],numZoomLevels:10,newMaxRes:21664,newMaxScale:8192e4,renderer:"canvas",center:[-1,1],zoom:5,layers:[],coordinate_system:"EPSG:25833",matrixSet:"EPSG:25833",extent:[-1,-1,-1,-1],extentUnits:"m",proxyHost:"",groups:[]},e)},(ISY=ISY||{}).Repository=ISY.Repository||{},ISY.Repository.StaticRepository=function(){var e=new ISY.Repository.MapConfig({numZoomLevels:18,newMaxRes:21664,renderer:ISY.MapImplementation.OL3.Map.RENDERERS.canvas,center:[570130,7032300],zoom:4,coordinate_system:"EPSG:32633",extent:[-2e6,35e5,3545984,9045984],extentunits:"m",proxyHost:"",layers:[{id:"1992",isBaseLayer:!0,subLayers:[{source:"WMS",url:["http://opencache.statkart.no/gatekeeper/gk/gk.open?LAYERS=norges_grunnkart"],gatekeeper:!0,name:"norges_grunnkart",format:"image/png",coordinate_system:"EPSG:32632",id:"1992",tiled:!0}],visibleOnLoad:!0},{id:"8001",isBaseLayer:!1,subLayers:[{source:"WFS",url:["https://kart5.nois.no/trondheim_neste/wfs/default.asp?conname=Regplan&"],name:"RpOmråde",version:"1.0.0",coordinate_system:"EPSG:32632",id:"8001",tiled:!1,style:"http://geoinnsyn.norconsultad.com/Services/ISY.GIS.IsyGeoinnsynConfig/api/v1/style?application=GeoInnsyn&name=RegplanVedtatt"}],visibleOnLoad:!0},{id:"8002",isBaseLayer:!1,subLayers:[{source:"WFS",url:["https://kart5.nois.no/trondheim_neste/wfs/default.asp?conname=Tiltak&"],name:"PblTiltak",version:"1.0.0",coordinate_system:"EPSG:32632",id:"8002",tiled:!1,style:"http://geoinnsyn.norconsultad.com/Services/ISY.GIS.IsyGeoinnsynConfig/api/v1/style?application=GeoInnsyn&name=pblTiltak_type"}],visibleOnLoad:!0}]});return{GetMapConfig:function(){return e}}},(ISY=ISY||{}).Utils=ISY.Utils||{},ISY.Utils.Guid=function(){function e(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return{NewGuid:function(){return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()}}};